# Template: Nginx microcache for /api/v1/menu.php (burst protection)
#
# Notes:
# - Microcache is meant for public GET responses that are identical across users.
# - MUST bypass when Authorization is present (and usually when cookies are present).
# - TTL should be small (0.5s - 5s) to reduce staleness.
#
# Place the cache zone at http{} level:
#   fastcgi_cache_path /var/cache/nginx/fastcgi_api_micro levels=1:2 keys_zone=APIMICRO:50m inactive=30s max_size=1g;
#
# Then include the location override inside server{}.

# http{} (NOT inside server{})
# fastcgi_cache_path /var/cache/nginx/fastcgi_api_micro levels=1:2 keys_zone=APIMICRO:50m inactive=30s max_size=1g;

# server{} helpers (or http{})
map $http_authorization $api_has_auth {
    default 1;
    ""      0;
}

map $http_cookie $api_has_cookie {
    default 1;
    ""      0;
}

map "$api_has_auth$api_has_cookie" $api_skip_microcache {
    default 1;
    "00"    0;  # no auth header AND no cookies
}

# server{}: only this endpoint is microcached
location = /api/v1/menu.php {
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php_fpm_api;

    fastcgi_cache APIMICRO;
    fastcgi_cache_bypass $api_skip_microcache;
    fastcgi_no_cache $api_skip_microcache;
    fastcgi_cache_valid 200 2s;
    fastcgi_cache_key "$scheme$request_method$host$request_uri";

    add_header X-Cache-Status $upstream_cache_status always;
}

