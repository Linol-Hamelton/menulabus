# Template: Nginx routing for web/api/sse pools
#
# Include inside your server{} for menu.labus.pro (after root / security headers),
# or translate to your FastPanel include structure.

# API (short requests)
location ^~ /api/v1/ {
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php_fpm_api;

    # Optional: disable FastCGI cache for API by default (use microcache on specific endpoints).
    fastcgi_cache off;
}

# SSE (long-lived)
location = /orders-sse.php {
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php_fpm_sse;

    fastcgi_buffering off;
    fastcgi_cache off;
    gzip off;

    # Keep-alive for streaming. Avoid 'Connection:' header on HTTP/2.
    add_header Cache-Control "no-store" always;
    add_header X-Accel-Buffering "no" always;

    fastcgi_read_timeout 40s;
}

# Optional legacy polling endpoint
location = /ws-poll.php {
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php_fpm_sse;

    fastcgi_buffering off;
    fastcgi_cache off;
    gzip off;

    add_header Cache-Control "no-store" always;
    add_header X-Accel-Buffering "no" always;
}

# Everything else -> web pool (default)
location / {
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php_fpm_web;

    # If you use FastCGI cache for HTML, keep your existing cache directives here.
}

