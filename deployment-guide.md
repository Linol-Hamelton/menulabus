# Руководство по применению оптимизаций

## 1. Применение оптимизированного конфига PHP-FPM

Созданный файл `php-fpm-optimized-final.conf` содержит оптимальные настройки для PHP-FPM 8.3 на основе анализа логов ошибок.

**Шаги:**

1. Скопируйте содержимое файла `php-fpm-optimized-final.conf` в конфигурацию вашего пула PHP-FPM.
   - Обычно конфигурационный файл пула находится в `/etc/php/8.3/fpm/pool.d/www.conf` (или аналогичный).
   - **Рекомендуется создать резервную копию** перед заменой.
   - В панели FastPanel найдите раздел "PHP-FPM" и замените конфигурацию на новую.

2. Перезапустите PHP-FPM:
   ```bash
   sudo systemctl restart php8.3-fpm
   ```
   Или через панель FastPanel: «Управление службами» → «php8.3-fpm» → «Перезапустить».

3. Проверьте статус службы:
   ```bash
   sudo systemctl status php8.3-fpm
   ```
   Убедитесь, что нет ошибок.

## 2. Применение оптимизированного конфига Nginx с FastCGI кэшем

Мы подготовили два конфигурационных файла:
- `nginx-fastcgi-cache.conf` — настройки FastCGI кэширования.
- `nginx-optimized.conf` — общие оптимизации Nginx.

**Шаги:**

1. Скопируйте содержимое `nginx-fastcgi-cache.conf` в соответствующий раздел конфигурации вашего сайта в Nginx.
   - Обычно файл конфигурации сайта находится в `/etc/nginx/sites-available/menu.labus.pro` (или аналогичный).
   - Добавьте блоки `fastcgi_cache_path` и `fastcgi_cache_key` в секцию `http`, а директивы `fastcgi_cache` и `fastcgi_cache_valid` в секцию `location ~ \.php$`.
   - В панели FastPanel найдите раздел «Nginx» и отредактируйте конфигурацию сайта.

2. Примените общие оптимизации из `nginx-optimized.conf` (таймауты, буферы, сжатие и т.д.).
   - Эти настройки можно добавить в тот же файл конфигурации сайта внутри блока `http` или `server`.

3. Проверьте синтаксис конфигурации:
   ```bash
   sudo nginx -t
   ```

4. Перезагрузите Nginx:
   ```bash
   sudo systemctl reload nginx
   ```
   Или через панель FastPanel: «Управление службами» → «nginx» → «Перезагрузить».

## 3. Добавление индексов в базу данных

Скрипт `db-indexes-optimizer.php` автоматически добавляет необходимые индексы. **Выполните его на продакшн-сервере после создания резервной копии БД.**

**Шаги:**

1. Загрузите файл `db-indexes-optimizer.php` в корневую директорию вашего сайта на сервере (например, `/var/www/labus_pro_usr/data/www/menu.labus.pro/`).

2. Запустите скрипт через браузер, открыв `https://menu.labus.pro/db-indexes-optimizer.php` (рекомендуется удалить файл после выполнения) или через командную строку:
   ```bash
   cd /var/www/labus_pro_usr/data/www/menu.labus.pro
   php db-indexes-optimizer.php
   ```

3. Убедитесь, что все индексы добавлены без ошибок. Если какой-то индекс уже существует — скрипт выведет ошибку, это нормально.

4. После добавления индексов выполните `ANALYZE TABLE` и `OPTIMIZE TABLE` для всех затронутых таблиц (можно через phpMyAdmin или консоль).

## 4. Настройка Redis для сессий (опционально, но рекомендуется)

Redis уже работает на сервере, но требуется установить расширение PHP-Redis.

**Шаги:**

1. Установите расширение `php-redis` через панель FastPanel:
   - Раздел «PHP-модули» → найдите «redis» и установите.
   - Если модуль недоступен, обратитесь в поддержку хостинга.

2. После установки расширения сессии автоматически переключатся на Redis (см. код `session_init.php`). Проверьте, что сессии работают:
   - Откройте `https://menu.labus.pro/test-redis.php` (предварительно загрузите файл на сервер).
   - Скрипт должен показать успешное подключение и использование Redis для сессий.

3. Если Redis недоступен, сессии продолжат использовать файлы (текущий каталог `/data/tmp`). Для ускорения можно смонтировать tmpfs в этот каталог (требует прав root).

## 5. Проверка и нагрузочное тестирование

После применения всех оптимизаций выполните нагрузочный тест, чтобы оценить улучшения.

**Используйте подготовленный скрипт `load_test.py`:**

1. Установите Python и библиотеку `requests` (если ещё не установлены):
   ```bash
   pip install requests
   ```

2. Запустите тест (с локального компьютера или с другого сервера):
   ```bash
   python load_test.py
   ```

3. Проанализируйте результаты: RPS (запросов в секунду) и TTFB (время до первого байта). Целевые показатели:
   - RPS > 800
   - TTFB < 100 мс

Если показатели не достигнуты, проверьте:
- Работает ли FastCGI кэш (заголовок `X-Cache` должен быть `HIT` для кэшированных страниц).
- Настройки PHP-FPM (количество процессов, память).
- Наличие медленных запросов в логах Nginx/PHP-FPM.

## 6. Дополнительные рекомендации

- **Мониторинг:** Включите мониторинг через `monitor.php` (уже есть в проекте) для отслеживания нагрузки и ошибок.
- **Кэширование статики:** Убедитесь, что статические файлы (CSS, JS, изображения) обслуживаются с длительным кэшированием (уже настроено в `session_init.php`).
- **Безопасность:** После внедрения проверьте, что заголовки безопасности (CSP, HSTS и др.) работают корректно.

## Контакты

Если возникнут проблемы, обратитесь к разработчикам или воспользуйтесь логами:
- Логи PHP-FPM: `/var/log/php8.3-fpm.log`
- Логи Nginx: `/var/log/nginx/error.log`
- Логи приложения: `/data/logs/`

Удачи!