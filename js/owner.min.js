/* MenuLabus - Optimized */
function initOwnerTabs(){const t=document.querySelectorAll(".menu-tabs-container .tab-btn");t.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),t.forEach(t=>t.classList.remove("active")),this.classList.add("active"),window.location.href=this.href})})}function initReportFilters(){const t=document.querySelector("select[name='period']");t&&t.addEventListener("change",function(){this.form.submit()})}function initCharts(){const t=document.getElementById("chartsContainer");t&&window.chartData&&0!==window.chartData.length?(t.innerHTML="",window.chartData.forEach((e,n)=>{const a=document.createElement("div");a.className="chart-container";const r=document.createElement("h3");r.className="chart-title",r.textContent=e.title;const o=document.createElement("div");o.className="chart-bars";const s=e.values.map(t=>{const e="string"==typeof t?parseFloat(t):t;return"number"!=typeof e||isNaN(e)?0:e}),c=Math.max(...s.filter(t=>t>0),1);e.values.forEach((t,a)=>{const r="string"==typeof t?parseFloat(t):t,s="number"!=typeof r||isNaN(r)?0:r,i=c>0?s/c*100:5,l=e.labels[a]||a+1,d=document.createElement("div");d.className="chart-bar",d.dataset.value=s,d.dataset.label=l,d.style.height=Math.max(i,20)+"%",d.style.backgroundColor=e.color||getDefaultColor(n);const h=document.createElement("span");h.className="chart-bar-value",h.textContent=formatValue(s);const u=document.createElement("span");u.className="chart-bar-label",u.textContent=formatLabel(l),d.appendChild(h),d.appendChild(u),o.appendChild(d)}),a.appendChild(r),a.appendChild(o),t.appendChild(a)}),document.querySelectorAll(".chart-bar").forEach(t=>{t.addEventListener("mouseenter",function(){this.style.transform="translateY(-8px) scale(1.08)",this.style.boxShadow="0 8px 20px rgba(0, 0, 0, 0.25)",this.style.zIndex="10"}),t.addEventListener("mouseleave",function(){this.style.transform="",this.style.boxShadow="",this.style.zIndex=""}),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},100)})):t&&(t.innerHTML="<p>Нет данных для построения графиков</p>")}function getDefaultColor(t){const e=["#cd1719","#121212","#2c83c2","#4CAF50","#ff9321","#712121","#db3a34","#000000","#555555","#f9f9f9"];return e[t%e.length]}function formatValue(t){return"number"!=typeof t?String(t):t===Math.floor(t)?t.toString():t.toFixed(2)}function formatLabel(t){const e=String(t);return e.length>12?e.substring(0,10)+"...":e}function refreshReport(){const t=new URL(window.location.href),e=t.searchParams.get("report")||"sales",n=t.searchParams.get("period")||"day";fetch(`/api/report?report=${e}&period=${n}`).then(t=>t.json()).then(t=>{updateReportTable(t)}).catch(t=>{console.error("Error refreshing report:",t)})}function updateReportTable(t){}document.addEventListener("DOMContentLoaded",function(){initOwnerTabs(),initReportFilters(),initCharts()});(function(){
  'use strict';

  function parseOwnerData(){
    var node=document.getElementById('owner-page-data');
    if(!node){return;}
    try{
      var payload=JSON.parse(node.value||'{}');
      window.chartData=Array.isArray(payload.chartData)?payload.chartData:[];
      window.currentPeriod=payload.currentPeriod||'day';
      window.currentReport=payload.currentReport||'sales';
      window.rawReportData=Array.isArray(payload.rawReportData)?payload.rawReportData:[];
    }catch(e){
      window.chartData=[];
      window.currentPeriod='day';
      window.currentReport='sales';
      window.rawReportData=[];
    }
  }

  function initOwnerAdminTabs(){
    var btns=document.querySelectorAll('.admin-tabs .admin-tab-btn');
    var panes=document.querySelectorAll('.admin-tab-pane');
    if(!btns.length||!panes.length){return;}
    var key='ownerAdminTab';
    function setTab(id,persist){
      btns.forEach(function(b){b.classList.toggle('active',b.getAttribute('data-tab')===id);});
      panes.forEach(function(p){p.classList.toggle('active',p.id===id);});
      if(persist){try{localStorage.setItem(key,id);}catch(_){}}
    }
    var initial=(function(){
      var active=[].find.call(btns,function(b){return b.classList.contains('active');});
      var fromDom=active?active.getAttribute('data-tab'):null;
      try{return localStorage.getItem(key)||fromDom;}catch(_){return fromDom;}
    })();
    btns.forEach(function(b){b.addEventListener('click',function(){setTab(b.getAttribute('data-tab'),true);});});
    if(initial){setTab(initial,false);}
  }

  function initRoleSaveButtons(){
    var buttons=document.querySelectorAll('.save-role-btn[data-user-id]');
    if(!buttons.length){return;}
    function findSelect(userId,btn){
      var row=btn.closest('tr, .mobile-table-row, .mobile-table-item');
      if(row){
        var s=row.querySelector('.role-select[data-user-id="'+userId+'"]');
        if(s){return s;}
      }
      return document.querySelector('.role-select[data-user-id="'+userId+'"]');
    }
    buttons.forEach(function(btn){
      btn.addEventListener('click',async function(){
        if(btn.dataset.busy==='1'){return;}
        var userId=btn.getAttribute('data-user-id');
        var select=findSelect(userId,btn);
        if(!select){return;}
        var role=select.value;
        var oldText=btn.textContent;
        btn.dataset.busy='1';
        btn.disabled=true;
        btn.textContent='Сохранение...';
        try{
          var resp=await fetch('/update_user_role.php',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
            credentials:'same-origin',
            body:JSON.stringify({user_id:Number(userId),role:role})
          });
          var data=null;
          try{data=await resp.json();}catch(_){data=null;}
          if(!resp.ok||!data||data.success!==true){throw new Error((data&&(data.error||data.message))||('HTTP '+resp.status));}
          btn.textContent='Сохранено';
          setTimeout(function(){btn.textContent=oldText;},900);
        }catch(err){
          console.error('Role update error:',err);
          btn.textContent=oldText;
          alert('Ошибка сохранения роли: '+err.message);
        }finally{
          btn.dataset.busy='0';
          btn.disabled=false;
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded',function(){
    parseOwnerData();
    initOwnerAdminTabs();
    initRoleSaveButtons();
  });
})();
