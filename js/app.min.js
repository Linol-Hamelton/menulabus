/* MenuLabus - Optimized */
const $=t=>document.querySelector(t),$$=t=>document.querySelectorAll(t);function initCartCounters(){document.querySelectorAll(".buy").forEach(t=>{const e=t.getAttribute("data-product-id"),a=cart.getItemCount(e),n=t.querySelector(".buy-text"),o=t.querySelector(".buy-counter"),s=o?.querySelector(".counter-value");s&&(s.textContent=a),a>0?(n&&n.classList.add("hidden"),o&&(o.classList.remove("hidden"),o.classList.add("active")),t.classList.add("buy-active")):(n&&n.classList.remove("hidden"),o&&(o.classList.add("hidden"),o.classList.remove("active")),t.classList.remove("buy-active"))})}function setupCartHandlers(){document.addEventListener("click",async t=>{const e=t.target.closest(".counter-plus, .counter-minus");if(e)return t.stopPropagation(),void await handleCounterClick(e);const a=t.target.closest(".buy-text");if(a){t.preventDefault();const e=a.closest(".buy");return void(e&&await addToCart(e))}const n=t.target.closest(".buy");n&&!t.target.closest(".buy-counter")&&(t.preventDefault(),await addToCart(n))})}async function handleCounterClick(t){const e=t.closest(".buy"),a=e.dataset.productId;if((t.classList.contains("counter-plus")?1:-1)>0){const t=e.getAttribute("data-product-name"),n=parseFloat(e.getAttribute("data-product-price")),o=e.getAttribute("data-product-image"),s=parseInt(e.getAttribute("data-calories"))||0,r=parseInt(e.getAttribute("data-protein"))||0,i=parseInt(e.getAttribute("data-fat"))||0,c=parseInt(e.getAttribute("data-carbs"))||0;cart.addProduct(a,t,n,o,s,r,i,c),cart.addItem(a)}else cart.removeItem(a);const n=cart.getItemCount(a),o=e.querySelector(".counter-value"),s=e.querySelector(".buy-text"),r=e.querySelector(".buy-counter");o&&(o.textContent=n),0===n?(s&&s.classList.remove("hidden"),r&&(r.classList.remove("active"),r.classList.add("hidden")),e.classList.remove("buy-active")):(s&&s.classList.add("hidden"),r&&(r.classList.add("active"),r.classList.remove("hidden")),e.classList.add("buy-active")),updateCartCounter(),updateOrderSummary()}async function addToCart(t){try{const e=t.getAttribute("data-product-id"),a=t.getAttribute("data-product-name"),n=parseFloat(t.getAttribute("data-product-price")),o=t.getAttribute("data-product-image"),s=parseInt(t.getAttribute("data-calories"))||0,r=parseInt(t.getAttribute("data-protein"))||0,i=parseInt(t.getAttribute("data-fat"))||0,c=parseInt(t.getAttribute("data-carbs"))||0;cart.addProduct(e,a,n,o,s,r,i,c),cart.addItem(e);const d=t.querySelector(".buy-text"),l=t.querySelector(".buy-counter"),u=l?.querySelector(".counter-value");d&&d.classList.add("hidden"),l&&(l.classList.add("active"),l.classList.remove("hidden")),u&&(u.textContent=cart.getItemCount(e)),t.classList.add("buy-active"),updateCartCounter(),updateOrderSummary(),showCartToast(a+" добавлен")}catch(t){console.error("Error adding to cart:",t)}}function showCartToast(t){let e=document.getElementById("cart-toast");e||(e=document.createElement("div"),e.id="cart-toast",e.style.cssText="position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(0,0,0,0.85);color:#fff;padding:10px 20px;border-radius:25px;font-size:14px;z-index:9999;opacity:0;transition:opacity 0.3s,transform 0.3s;pointer-events:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;",document.body.appendChild(e)),e.textContent=t,e.style.opacity="1",e.style.transform="translateX(-50%) translateY(0)",clearTimeout(e._timer),e._timer=setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(-50%) translateY(20px)"},1500)}function validateCSRF(t){return t&&64===t.length}function initMobileMenu(){const t=$(".mobile-menu-btn"),e=$(".nav");t&&e&&(t.addEventListener("click",a=>{a.stopPropagation(),e.classList.toggle("active"),t.classList.toggle("active")}),document.addEventListener("click",a=>{!e.classList.contains("active")||e.contains(a.target)||t.contains(a.target)||(e.classList.remove("active"),t.classList.remove("active"))}),e.addEventListener("click",t=>t.stopPropagation()))}function initFormValidation(){$$("form").forEach(t=>{t.addEventListener("submit",e=>{t.querySelectorAll('input[type="password"]').forEach(t=>{if(t.value.length<8&&"current_password"!==t.name){e.preventDefault();let a=t.parentNode.querySelector(".field-error");a||(a=document.createElement("div"),a.className="field-error",a.style.cssText="color:#d40000;font-size:13px;margin-top:4px;",t.parentNode.appendChild(a)),a.textContent="Минимум 8 символов",t.style.borderColor="#d40000",t.addEventListener("input",function e(){const a=t.parentNode.querySelector(".field-error");a&&a.remove(),t.style.borderColor="",t.removeEventListener("input",e)})}})})})}function initReservationForm(){const t=$("#reservationForm");t&&t.addEventListener("submit",async e=>{e.preventDefault();const a=$("#formMessage");a&&(a.className="message",a.style.display="block",a.textContent="Отправка данных...");const n={name:t.name.value,phone:t.phone.value,date:t.date.value,time:t.time.value,guests:t.guests.value,timestamp:(new Date).toISOString()},o=`Новая бронь:\nИмя: ${n.name}\nТелефон: ${n.phone}\nДата: ${n.date}\nВремя: ${n.time}\nГостей: ${n.guests}`,s=window.Security?.signData?{signedData:await window.Security.signData(n,"reservation-secret-key"),text:o,type:"reservation",isSigned:!0}:{text:o,type:"reservation"};try{const e=await fetch("send_message.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),n=await e.json();if(!n.ok)throw new Error(n.error);a.textContent="Ваша заявка принята! Мы скоро свяжемся с вами.",a.className="message success",t.reset()}catch(t){a.textContent="Произошла ошибка. Попробуйте позже или позвоните нам.",a.className="message error"}})}function setupTabs(t){const e=$(t);if(!e)return;const a=e.querySelectorAll(".tab-btn"),n=e.querySelectorAll(".tab-pane");if(!a.length||!n.length)return;function o(t,e=!1){a.forEach(e=>e.classList.toggle("active",e.dataset.tab===t)),n.forEach(e=>e.classList.toggle("active",e.id===t)),e&&(localStorage.setItem("activeTab",t),document.cookie=`activeTab=${t}; path=/; max-age=31536000`)}a.forEach(t=>t.addEventListener("click",()=>{o(t.dataset.tab,!0)}));const s=localStorage.getItem("activeTab")||Array.from(a).find(t=>t.classList.contains("active"))?.dataset.tab;s&&o(s,!1)}function setupMenuTabs(){const t=$$(".menu-tabs-container .tab-btn"),e=$$(".menu-content .tab-pane");if(!t.length||!e.length)return;function a(a,n=!0){t.forEach(t=>t.classList.toggle("active",t.dataset.tab===a)),e.forEach(t=>t.classList.toggle("active",t.id===a)),n&&(localStorage.setItem("activeMenuCategory",a),document.cookie=`activeMenuCategory=${a}; path=/; max-age=31536000`)}t.forEach(t=>t.addEventListener("click",()=>a(t.dataset.tab)));const n=new URLSearchParams(location.search).get("tab")||localStorage.getItem("activeMenuCategory")||t[0]?.dataset.tab;n&&a(n,!1)}function setupMenuCategoryFilter(){const t=$$(".menu-tabs-container .tab-btn"),e=$$(".tab-row[data-category]");if(!t.length||!e.length)return;t.forEach(a=>a.addEventListener("click",()=>{const n=a.dataset.tab;t.forEach(t=>t.classList.toggle("active",t===a)),e.forEach(t=>t.style.display=t.dataset.category===n?"":"none")}));const a=t[0]?.dataset.tab;a&&e.forEach(t=>t.style.display=t.dataset.category===a?"":"none")}function getCookie(t){const e=`; ${document.cookie}`.split(`; ${t}=`);if(2===e.length)return e.pop().split(";").shift()}function showCompositionModal(t){const e=t.getAttribute("data-composition")||"—",a=t.getAttribute("data-calories"),n=t.getAttribute("data-protein"),o=t.getAttribute("data-fat"),s=t.getAttribute("data-carbs"),r=t.getAttribute("data-name"),i=t.getAttribute("data-image"),c=t.getAttribute("data-description");document.getElementById("modalTitle").textContent=r,document.getElementById("modalImage").src=i,document.getElementById("modalDescription").textContent=c,document.getElementById("modalComposition").textContent=e,document.getElementById("modalCalories").textContent=a,document.getElementById("modalProtein").textContent=n,document.getElementById("modalFat").textContent=o,document.getElementById("modalCarbs").textContent=s,document.getElementById("compositionModal").style.display="flex"}function closeCompositionModal(){document.getElementById("compositionModal").style.display="none"}function toggleCounter(t,e){const a=$(`.buy[data-product-id="${t}"]`),n=a?.querySelector(".buy-text"),o=a?.querySelector(".buy-counter");a&&n&&o&&(n.classList.toggle("hidden",e),o.classList.toggle("hidden",!e))}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")}),document.addEventListener("DOMContentLoaded",function(){document.getElementById("saveFontsBtn")&&initializeDesignManager()}),document.addEventListener("DOMContentLoaded",()=>{initMobileMenu(),initFormValidation(),initReservationForm(),setupTabs(".account-tabs-container"),setupMenuTabs(),setupMenuCategoryFilter(),initCartCounters(),document.addEventListener("click",t=>{t.target.classList.contains("modal-trigger")&&showCompositionModal(t.target)}),setupCartHandlers()}),window.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("compositionModal"),e=document.getElementById("closeModalBtn");t&&t.addEventListener("click",t=>{t.target===t.currentTarget&&closeCompositionModal()}),e&&e.addEventListener("click",closeCompositionModal)}),document.addEventListener("keydown",t=>{if("Escape"!==t.key)return;const e=document.getElementById("compositionModal");if(e&&"none"!==e.style.display)return void closeCompositionModal();const a=document.getElementById("deliveryModal");return a&&"flex"===a.style.display?(a.style.display="none",void(document.body.style.overflow="")):void 0});const noContextElements=document.querySelectorAll(".no-context");noContextElements.forEach(t=>{t.addEventListener("contextmenu",function(t){t.preventDefault()})});