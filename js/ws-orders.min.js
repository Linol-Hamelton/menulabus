/* MenuLabus - SSE with polling fallback */
(function () {
  "use strict";

  var lastTimestamp = 0;
  var pollAbortController = null;
  var pollingActive = false;
  var source = null;
  var reconnectTimer = null;

  var isEmployeePage = document.body.classList.contains("employee-page");
  var isCustomerOrdersPage = document.body.classList.contains("customer_orders-page");
  var isAdminFormContainer = document.body.classList.contains("admin-form-container");
  var cartTotalCountEl = document.getElementById("cart-total-count");

  function rebindOrderInteractions() {
    document.querySelectorAll(".status-btn, .status-btn-r").forEach(function (button) {
      var clone = button.cloneNode(true);
      button.replaceWith(clone);
      clone.addEventListener("click", function () {
        // existing handlers are attached by page scripts; keep noop bind to preserve behavior
      });
    });

    document.querySelectorAll(".repeat-order-form").forEach(function (form) {
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        if (typeof repeatOrder === "function") {
          var orderId = this.dataset.orderId;
          repeatOrder(orderId);
        }
      });
    });

    document.querySelectorAll("[data-toggle-order]").forEach(function (toggle) {
      toggle.addEventListener("click", function () {
        if (this.parentElement) {
          this.parentElement.classList.toggle("expanded");
        }
      });
    });
  }

  function replaceSectionFromHtml(containerSelector, html) {
    var parser = new DOMParser();
    var parsed = parser.parseFromString(html, "text/html");
    var next = parsed.querySelector(containerSelector);
    var current = document.querySelector(containerSelector);
    if (!next || !current) {
      return;
    }

    var activeTab = document.querySelector(".tab-btn.active");
    var activeTabName = activeTab ? activeTab.dataset.tab : null;

    current.outerHTML = next.outerHTML;

    if (activeTabName) {
      var tabButton = document.querySelector('.tab-btn[data-tab="' + activeTabName + '"]');
      var tabPane = document.getElementById(activeTabName);
      if (tabButton) tabButton.classList.add("active");
      if (tabPane) tabPane.classList.add("active");
    }
  }

  function refreshOrdersHtml() {
    fetch(location.href)
      .then(function (r) {
        return r.text();
      })
      .then(function (html) {
        if (isEmployeePage || isAdminFormContainer) {
          replaceSectionFromHtml(".orders-list", html);
        } else if (isCustomerOrdersPage) {
          replaceSectionFromHtml(".account-sections", html);
        }
        rebindOrderInteractions();
      })
      .catch(function () {
        // no-op
      });
  }

  function handlePayload(payload) {
    if (!payload || typeof payload !== "object") {
      return;
    }

    if (payload.timestamp && payload.timestamp > lastTimestamp) {
      lastTimestamp = payload.timestamp;
    }

    if (cartTotalCountEl && typeof payload.cartTotal !== "undefined") {
      cartTotalCountEl.textContent = payload.cartTotal;
    }

    if (!payload.orderUpdated) {
      return;
    }

    if (isEmployeePage || isAdminFormContainer) {
      refreshOrdersHtml();
      return;
    }

    if (isCustomerOrdersPage) {
      var shouldRefresh = false;
      var currentOrderItems = document.querySelectorAll(".order-item");
      currentOrderItems.forEach(function (item) {
        var id = parseInt(item.dataset.orderId || "0", 10);
        if (Array.isArray(payload.changedOrderIds) && payload.changedOrderIds.indexOf(id) !== -1) {
          shouldRefresh = true;
        }
      });

      if (shouldRefresh || (Array.isArray(payload.changedOrderIds) && payload.changedOrderIds.length === 0)) {
        refreshOrdersHtml();
      }
    }
  }

  function startPolling() {
    if (pollingActive) {
      return;
    }
    pollingActive = true;

    function run() {
      if (pollAbortController) {
        pollAbortController.abort();
      }
      pollAbortController = new AbortController();

      fetch("/ws-poll.php?t=" + lastTimestamp, { signal: pollAbortController.signal })
        .then(function (response) {
          if (!response.ok) {
            throw new Error("http " + response.status);
          }
          return response.json();
        })
        .then(function (payload) {
          handlePayload(payload);
        })
        .catch(function () {
          // no-op
        })
        .finally(function () {
          var delay = document.hasFocus() ? 15000 : 60000;
          setTimeout(run, delay);
        });
    }

    run();
  }

  function scheduleReconnect() {
    if (reconnectTimer) {
      clearTimeout(reconnectTimer);
    }
    reconnectTimer = setTimeout(function () {
      startSSE();
    }, 3000);
  }

  function startSSE() {
    if (!("EventSource" in window)) {
      startPolling();
      return;
    }

    if (source) {
      source.close();
    }

    var opened = false;
    source = new EventSource("/orders-sse.php?t=" + lastTimestamp);

    source.onopen = function () {
      opened = true;
    };

    source.addEventListener("update", function (event) {
      try {
        handlePayload(JSON.parse(event.data));
      } catch (e) {
        // no-op
      }
    });

    source.addEventListener("ping", function (event) {
      try {
        handlePayload(JSON.parse(event.data));
      } catch (e) {
        // no-op
      }
    });

    source.onerror = function () {
      if (source) {
        source.close();
      }

      // If SSE cannot establish connection at all, fallback to polling.
      if (!opened) {
        startPolling();
      } else {
        scheduleReconnect();
      }
    };

    // If nothing opened shortly after init, fallback to polling.
    setTimeout(function () {
      if (!opened && !pollingActive) {
        if (source) source.close();
        startPolling();
      }
    }, 8000);
  }

  window.addEventListener("load", function () {
    rebindOrderInteractions();
    startSSE();
  });
})();

