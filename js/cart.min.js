/* MenuLabus - Optimized */
function updateCartCounter() {
    const e = cart.getTotalCount(),
        t = document.getElementById("cart-total-count"),
        n = t?.closest("a");
    (t && t.setAttribute("data-value", e),
        n && n.classList.toggle("has-items", e > 0));
}
function updateOrderSummary() {
    const e = cart.getTotalSum(),
        t = document.querySelector(".order-summary-btn .order-total");
    t && (t.textContent = `${e} ‚ÇΩ`);
    const n = document.getElementById("cart-total");
    n && (n.textContent = `–ò—Ç–æ–≥–æ: ${e} ‚ÇΩ`);
}
function renderCartItems(e, t) {
    const n = document.getElementById("cart-items-container"),
        r = document.getElementById("checkout-btn"),
        a = document.getElementById("nutrition-summary");
    if (!n || !r) return;
    const o = {};
    Array.from(n.children).forEach((e) => {
        const t = e.getAttribute("data-product-id");
        t && (o[t] = e);
    });
    let i = !1,
        s = 0,
        c = 0,
        d = 0,
        l = 0;
    for (const r in e) {
        if (!e.hasOwnProperty(r)) continue;
        const a = t[r];
        if (!a) continue;
        i = !0;
        const u = e[r];
        ((s += (a.calories || 0) * u),
            (c += (a.protein || 0) * u),
            (d += (a.fat || 0) * u),
            (l += (a.carbs || 0) * u));
        let m = o[r];
        if (m) {
            const e = m.querySelector(".cart-item-quantity span");
            e && (e.textContent = u);
        } else
            ((m = document.createElement("div")),
                (m.className = "cart-item"),
                m.setAttribute("data-product-id", r),
                (m.innerHTML = `\n    <div class="cart-item-info">\n        <img src="${a.image || "placeholder.jpg"}" \n             loading="lazy" \n             draggable="false" \n             oncontextmenu="return false"\n             alt="${a.name}" \n             class="cart-item-image">\n        <div>\n            <div class="cart-item-title">${a.name}</div>\n            <div class="cart-item-price">${a.price} ‚ÇΩ</div>\n        </div>\n    </div>\n    <div class="cart-item-quantity">\n        <button class="quantity-btn" data-action="increase" data-product-id="${r}">+</button>\n        <span>${u}</span>\n        <button class="quantity-btn" data-action="decrease" data-product-id="${r}">-</button>\n    </div>\n`),
                n.appendChild(m));
    }
    for (const t in o) e[t] || o[t].remove();
    if (
        (a &&
            (a.innerHTML = i
                ? `\n            <div class="nutrition-item">–ö–∞–ª–æ—Ä–∏–∏: ${Math.round(s)} –∫–∫–∞–ª</div>\n            <div class="nutrition-item">–ë–µ–ª–∫–∏: ${Math.round(c)} –≥</div>\n            <div class="nutrition-item">–ñ–∏—Ä—ã: ${Math.round(d)} –≥</div>\n            <div class="nutrition-item">–£–≥–ª–µ–≤–æ–¥—ã: ${Math.round(l)} –≥</div>\n        `
                : ""),
            i)
    ) {
        const e = n.querySelector(".empty-cart");
        (e && e.remove(), (r.disabled = !1), updateNutritionSummary());
    } else
        (n.querySelector(".empty-cart") ||
            (n.innerHTML =
                '\n            <div class="empty-cart">\n                <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>\n            </div>\n        '),
            (r.disabled = !0),
            a && (a.innerHTML = ""));
    updateOrderSummary();
}
function changeCartQuantity(e, t, n = null) {
    n && n.stopPropagation();
    const r = window.scrollY,
        a = 0 === Object.keys(cart.items).length;
    (t > 0 ? cart.addItem(e) : cart.removeItem(e),
        a !== (0 === Object.keys(cart.items).length)
            ? renderCartItems(cart.items, cart.products)
            : (updateCartItemUI(e), updateNutritionSummary()),
        updateOrderSummary(),
        updateAllCartButtons(),
        window.scrollTo(0, r));
}
function updateCartItemUI(e) {
    const t = document.querySelector(`.cart-item[data-product-id="${e}"]`);
    if (!t) return;
    const n = cart.getItemCount(e),
        r = t.querySelector(".cart-item-quantity span");
    n > 0 ? r && (r.textContent = n) : t.remove();
}
function updateNutritionSummary() {
    const e = document.getElementById("nutrition-summary");
    if (!e) return;
    let t = 0,
        n = 0,
        r = 0,
        a = 0;
    for (const e in cart.items) {
        const o = cart.products[e];
        if (!o) continue;
        const i = cart.items[e];
        ((t += (o.calories || 0) * i),
            (n += (o.protein || 0) * i),
            (r += (o.fat || 0) * i),
            (a += (o.carbs || 0) * i));
    }
    e.innerHTML =
        Object.keys(cart.items).length > 0
            ? `\n        <div class="nutrition-item">–ö–∞–ª–æ—Ä–∏–∏: ${Math.round(t)} –∫–∫–∞–ª</div>\n        <div class="nutrition-item">–ë–µ–ª–∫–∏: ${Math.round(n)} –≥</div>\n        <div class="nutrition-item">–ñ–∏—Ä—ã: ${Math.round(r)} –≥</div>\n        <div class="nutrition-item">–£–≥–ª–µ–≤–æ–¥—ã: ${Math.round(a)} –≥</div>\n    `
            : "";
}
function clearCart() {
    confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?") &&
        ((cart.items = {}),
            (cart.products = {}),
            localStorage.removeItem("cart"),
            localStorage.removeItem("products"),
            renderCartItems({}, {}),
            updateCartCounter(),
            updateOrderSummary(),
            updateAllCartButtons());
}
function changeMenuQuantity(e, t, n = null) {
    e.stopPropagation();
    const r = e.target.closest(".buy-counter");
    if (!r) return;
    const a = r.querySelector(".counter-value"),
        o = r.closest(".buy"),
        i = o.getAttribute("data-product-id");
    if (!n || validateCSRF(n)) {
        if (t > 0)
            (cart.addItem(i),
                o.classList.add("buy-active"),
                a && (a.textContent = cart.getItemCount(i)));
        else if (cart.removeItem(i)) {
            const e = o.querySelector(".buy-text");
            (e && (e.style.display = "inline"),
                r && (r.style.display = "none"),
                o.classList.remove("buy-active"));
        } else a && (a.textContent = cart.getItemCount(i));
        updateOrderSummary();
    }
}
async function toggleCart(e, t = null) {
    try {
        const n = e.getAttribute("data-product-id"),
            r = e.getAttribute("data-product-name"),
            a = parseFloat(e.getAttribute("data-product-price")),
            o = e.getAttribute("data-product-image"),
            i = parseInt(e.getAttribute("data-calories")) || 0,
            s = parseInt(e.getAttribute("data-protein")) || 0,
            c = parseInt(e.getAttribute("data-fat")) || 0,
            d = parseInt(e.getAttribute("data-carbs")) || 0;
        if (t && "function" == typeof window.verifyData) {
            const e = await verifyData(t, "cart-secret-key");
            if (!e) return;
            cart.addProduct(
                e.id || n,
                e.name || r,
                e.price || a,
                e.image || o,
                e.calories || i,
                e.protein || s,
                e.fat || c,
                e.carbs || d,
            );
        } else cart.addProduct(n, r, a, o, i, s, c, d);
        const l = e.querySelector(".buy-text"),
            u = e.querySelector(".buy-counter");
        0 === cart.getItemCount(n) &&
            (cart.addItem(n),
                l && (l.style.display = "none"),
                u && (u.style.display = "flex"),
                e.classList.add("buy-active"));
    } catch (e) { }
}
function updateAllCartButtons() {
    document.querySelectorAll(".buy").forEach((e) => {
        const t = e.getAttribute("data-product-id"),
            n = cart.getItemCount(t),
            r = e.querySelector(".buy-text"),
            a = e.querySelector(".buy-counter"),
            o = a?.querySelector(".counter-value");
        n > 0
            ? (r && r.classList.add("hidden"),
                a && (a.classList.add("active"), a.classList.remove("hidden")),
                o && (o.textContent = n),
                e.classList.add("buy-active"))
            : (r && r.classList.remove("hidden"),
                a && (a.classList.remove("active"), a.classList.add("hidden")),
                e.classList.remove("buy-active"));
    });
}
async function setupCheckoutButton() {
    if (!window.isLoggedIn) return void showGuestModal();
    if (!document.querySelector('meta[name="csrf-token"]')?.content)
        return void showOrderMessage(
            "‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.",
            "error",
        );
    const e = document.getElementById("checkout-btn");
    if (!e) return;
    if (0 === Object.keys(cart.items).length)
        return void showOrderMessage("‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!", "error");
    const t = localStorage.getItem("deliveryType"),
        n = localStorage.getItem("deliveryDetails") || "";
    if (!t)
        return void showOrderMessage(
            "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞",
            "error",
        );
    if ("delivery" === t && !n.trim())
        return void showOrderMessage("‚ùå –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏", "error");
    if ("table" === t && !n.trim())
        return void showOrderMessage("‚ùå –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å—Ç–æ–ª–∞", "error");
    if (!confirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞?")) return;
    const r = e.innerHTML;
    ((e.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ...'),
        (e.disabled = !0));
    try {
        const e = [];
        let n = 0;
        for (const t in cart.items)
            if (cart.products[t]) {
                const r = cart.products[t],
                    a = cart.items[t];
                ((n += r.price * a),
                    e.push({
                        id: t,
                        name: r.name,
                        price: r.price,
                        quantity: a,
                        image: r.image,
                    }));
            }
        const r =
            document.querySelector('meta[name="csrf-token"]')?.content ||
            window.csrfToken ||
            "<?= $_SESSION['csrf_token'] ?? '' ?>",
            a = await fetch("create_new_order.php", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRF-Token": r },
                body: JSON.stringify({
                    items: e,
                    total: n,
                    delivery_type: t,
                    delivery_details: localStorage.getItem("deliveryDetails") || "",
                    csrf_token: r,
                }),
            }),
            o = a.headers.get("content-type");
        if (!o || !o.includes("application/json")) {
            const e = await a.text();
            throw new Error(`–û–∂–∏–¥–∞–ª—Å—è JSON, –Ω–æ –ø–æ–ª—É—á–µ–Ω: ${e.slice(0, 50)}...`);
        }
        const i = await a.json();
        if (!i.success) throw new Error(i.error || "–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞");
        if (
            ((cart.items = {}),
                (cart.products = {}),
                localStorage.removeItem("cart"),
                localStorage.removeItem("products"),
                localStorage.removeItem("deliveryType"),
                localStorage.removeItem("deliveryDetails"),
                renderCartItems({}, {}),
                updateCartCounter(),
                updateOrderSummary(),
                showOrderMessage(`‚úÖ –ó–∞–∫–∞–∑ #${i.orderId} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!`, "success"),
                "undefined" != typeof PushNotifications)
        )
            PushNotifications.init({ orderId: i.orderId });
        else {
            const e = document.createElement("script");
            ((e.src = "/js/push-notifications.js"),
                (e.onload = () => {
                    window.PushNotifications &&
                        window.PushNotifications.init({ orderId: i.orderId });
                }),
                document.head.appendChild(e));
        }
        setTimeout(() => {
            window.location.href = "customer_orders.php";
        }, 2e3);
    } catch (e) {
        showOrderMessage(
            `‚ùå ${e.message || "–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}`,
            "error",
        );
    } finally {
        ((e.innerHTML = r), (e.disabled = !1));
    }
}
function showOrderMessage(e, t) {
    let n = document.getElementById("orderMessage");
    (n ||
        ((n = document.createElement("div")),
            (n.id = "orderMessage"),
            (n.className = "order-message"),
            document.querySelector(".container-cart")?.appendChild(n)),
        (n.style.display = "block"),
        (n.className = "order-message " + t),
        (n.innerHTML = e));
}
function showGuestModal() {
    const e = document.getElementById("guestOrderModal");
    e && ((e.style.display = "flex"), (document.body.style.overflow = "hidden"));
}
function hideGuestModal() {
    const e = document.getElementById("guestOrderModal");
    e && ((e.style.display = "none"), (document.body.style.overflow = ""));
}
function initGuestModal() {
    if (!document.getElementById("guestOrderModal")) return;
    const e = document.getElementById("guestLoginBtn"),
        t = document.getElementById("guestRegisterBtn"),
        n = document.getElementById("guestCallBtn"),
        r = document.getElementById("cancelGuestBtn"),
        a = document.getElementById("guestPhone");
    (e &&
        e.addEventListener("click", () => {
            window.location.href = "https://menu.labus.pro/auth.php";
        }),
        t &&
        t.addEventListener("click", () => {
            window.location.href = "https://menu.labus.pro/auth.php?mode=register";
        }),
        r && r.addEventListener("click", hideGuestModal),
        a &&
        a.addEventListener("input", function () {
            const e = this.value.trim().replace(/\D/g, "").length >= 10;
            n.disabled = !e;
        }),
        n &&
        n.addEventListener("click", async () => {
            const e = a.value.trim();
            if (!e) return;
            if (0 === Object.keys(cart.items).length)
                return void alert("‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            const t = [];
            let r = 0;
            for (const e in cart.items)
                if (cart.products[e]) {
                    const n = cart.products[e],
                        a = cart.items[e];
                    ((r += n.price * a),
                        t.push({
                            id: e,
                            name: n.name,
                            price: n.price,
                            quantity: a,
                            image: n.image,
                        }));
                }
            const o = localStorage.getItem("deliveryType") || "bar",
                i = localStorage.getItem("deliveryDetails") || "",
                s = n.innerHTML;
            ((n.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...'),
                (n.disabled = !0));
            try {
                const n =
                    document.querySelector('meta[name="csrf-token"]')?.content || "",
                    a = { "Content-Type": "application/json" };
                n && (a["X-CSRF-Token"] = n);
                const s = await fetch("create_guest_order.php", {
                    method: "POST",
                    headers: a,
                    body: JSON.stringify({
                        items: t,
                        total: r,
                        phone: e,
                        delivery_type: o,
                        delivery_details: i,
                        csrf_token: n,
                    }),
                }),
                    c = await s.json();
                if (!c.success)
                    throw new Error(c.error || "–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞");
                if (
                    ((cart.items = {}),
                        (cart.products = {}),
                        localStorage.removeItem("cart"),
                        localStorage.removeItem("products"),
                        localStorage.removeItem("deliveryType"),
                        localStorage.removeItem("deliveryDetails"),
                        renderCartItems({}, {}),
                        updateCartCounter(),
                        updateOrderSummary(),
                        hideGuestModal(),
                        alert(
                            `‚úÖ –ó–∞–∫–∞–∑ #${c.orderId} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É.`,
                        ),
                        "undefined" != typeof PushNotifications)
                )
                    PushNotifications.init({ phone: e, orderId: c.orderId });
                else {
                    const t = document.createElement("script");
                    ((t.src = "/js/push-notifications.js"),
                        (t.onload = () => {
                            window.PushNotifications &&
                                window.PushNotifications.init({
                                    phone: e,
                                    orderId: c.orderId,
                                });
                        }),
                        document.head.appendChild(t));
                }
            } catch (e) {
                alert(
                    `‚ùå ${e.message || "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}`,
                );
            } finally {
                ((n.innerHTML = s), (n.disabled = !1));
            }
        }));
}
((window.isLoggedIn =
    "true" ===
    document.getElementById("body")?.getAttribute("data-is-logged-in")),
    window.cart ||
    (window.cart = {
        items: (() => {
            try {
                const e = localStorage.getItem("cart");
                return e ? JSON.parse(e) : {};
            } catch {
                return {};
            }
        })(),
        products: (() => {
            try {
                const e = localStorage.getItem("products");
                return e ? JSON.parse(e) : {};
            } catch {
                return {};
            }
        })(),
        addProduct: function (e, t, n, r, a, o, i, s) {
            ((this.products[e] = {
                id: e,
                name: t,
                price: n,
                image: r,
                calories: a,
                protein: o,
                fat: i,
                carbs: s,
            }),
                localStorage.setItem("products", JSON.stringify(this.products)));
        },
        addItem: function (e) {
            (this.items[e] ? this.items[e]++ : (this.items[e] = 1),
                this.save(),
                updateOrderSummary());
        },
        removeItem: function (e) {
            let t = !1;
            return (
                this.items[e] &&
                (this.items[e]--,
                    this.items[e] <= 0 && (delete this.items[e], (t = !0))),
                this.save(),
                updateOrderSummary(),
                t
            );
        },
        getItemCount: function (e) {
            return this.items[e] || 0;
        },
        getTotalCount: function () {
            return Object.values(this.items).reduce((e, t) => e + t, 0);
        },
        getTotalSum: function () {
            return Object.entries(this.items).reduce((e, [t, n]) => {
                const r = this.products[t];
                return e + (r ? r.price * n : 0);
            }, 0);
        },
        save: function () {
            (localStorage.setItem("cart", JSON.stringify(this.items)),
                updateCartCounter());
        },
    }),
    (cart.addProduct = function (e, t, n, r, a, o, i, s) {
        ((this.products[e] = {
            id: e,
            name: t,
            price: n,
            image: r,
            calories: a || 0,
            protein: o || 0,
            fat: i || 0,
            carbs: s || 0,
        }),
            localStorage.setItem("products", JSON.stringify(this.products)));
    }),
    document.addEventListener("DOMContentLoaded", function () {
        (renderCartItems(cart.items, cart.products),
            updateCartCounter(),
            updateOrderSummary(),
            updateAllCartButtons());
    }),
    document.addEventListener("click", (e) => {
        const t = e.target.closest(".quantity-btn[data-action]");
        t &&
            (e.stopPropagation(),
                changeCartQuantity(
                    t.dataset.productId,
                    "increase" === t.dataset.action ? 1 : -1,
                ));
    }),
    document.addEventListener("DOMContentLoaded", function () {
        const e = document.getElementById("deliveryModal"),
            t = document.getElementById("confirmDeliveryBtn"),
            n = document.getElementById("cancelDeliveryBtn"),
            r = document.getElementById("checkout-btn"),
            a = document.getElementById("deliveryAddressBlock"),
            o = document.getElementById("tableQrBlock"),
            i = document.getElementById("deliveryAddress"),
            s = document.getElementById("tableNumber"),
            c = document.getElementById("qrResult"),
            d = document.getElementById("scanQrBtn"),
            l = document.querySelectorAll(".delivery-option"),
            u = document.getElementById("detectLocationBtn"),
            m = document.querySelector(".location-permission-hint");
        let p = null,
            y = null;
        function g() {
            e &&
                ((e.style.display = "none"), (document.body.style.overflow = ""), f());
        }
        function f() {
            y &&
                y
                    .stop()
                    .then(() => {
                        ((y = null), d && (d.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"));
                    })
                    .catch((e) => {
                        ((y = null), d && (d.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"));
                    });
        }
        function v(e) {
            const n = e.currentTarget,
                r = n.dataset.type;
            (l.forEach((e) => e.classList.remove("active")),
                n.classList.add("active"),
                (p = r),
                a && a.classList.add("hidden"),
                o && o.classList.add("hidden"),
                "delivery" === r && a
                    ? (a.classList.remove("hidden"),
                        setTimeout(function () {
                            "function" == typeof window.initAddressAutocomplete &&
                                window.initAddressAutocomplete();
                        }, 100))
                    : "table" === r &&
                    o &&
                    (o.classList.remove("hidden"),
                        b().then((e) => {
                            e.available || showOrderMessage(`‚ö†Ô∏è ${e.reason}`, "warning");
                        })),
                t && (t.disabled = !1),
                "table" !== r && f());
        }
        (l.forEach((e) => {
            e.addEventListener("click", v);
        }),
            d &&
            d.addEventListener("click", async function () {
                if (window.qrScannerManager) {
                    if (window.qrScannerManager.isScanning)
                        try {
                            return (
                                await window.qrScannerManager.stopScanning(),
                                void (d.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å")
                            );
                        } catch (e) { }
                    try {
                        const e = await b();
                        if (!e.available)
                            return void showOrderMessage(`‚ùå ${e.reason}`, "error");
                        ((
                            await navigator.mediaDevices.getUserMedia({
                                video: { facingMode: "environment" },
                            })
                        )
                            .getTracks()
                            .forEach((e) => e.stop()),
                            await window.qrScannerManager.startScanning(
                                "qr-scanner-container",
                                (e) => {
                                    (s && (s.value = e),
                                        c && (c.textContent = `–°—Ç–æ–ª ‚Ññ${e}`),
                                        window.qrScannerManager &&
                                        window.qrScannerManager.stopScanning().catch(() => { }),
                                        (d.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"));
                                },
                            ),
                            (d.textContent = "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"));
                    } catch (e) {
                        const t = e?.message || "UNKNOWN_ERROR";
                        let n = `‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${t}`;
                        switch (t) {
                            case "PERMISSION_DENIED":
                                n =
                                    '‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ<br>\n                    <div class="camera-instructions">\n                    <ol>\n                        <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∫–∞–º–µ—Ä—ã üì∑ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>\n                        <li>–í—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</li>\n                        <li>–ù–∞–∂–º–∏—Ç–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" —Å–Ω–æ–≤–∞</li>\n                    </ol>\n                    </div>';
                                break;
                            case "CAMERA_NOT_FOUND":
                                n =
                                    '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞<br>\n                    <div class="camera-instructions">\n                    <p>–ù–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–∞–º–µ—Ä–∞.</p>\n                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞.</p>\n                    </div>';
                                break;
                            case "QR_CODE_NOT_FOUND":
                                n =
                                    '‚ùå QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω<br>\n                    <div class="camera-instructions">\n                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>\n                    <ol>\n                        <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ QR-–∫–æ–¥ —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω</li>\n                        <li>–ü–æ–¥–Ω–µ—Å–∏—Ç–µ –∫–∞–º–µ—Ä—É –±–ª–∏–∂–µ –∫ –∫–æ–¥—É</li>\n                        <li>–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ</li>\n                    </ol>\n                    </div>';
                                break;
                            case "CAMERA_NOT_SUPPORTED":
                                n =
                                    '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è<br>\n                    <div class="camera-instructions">\n                    <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.</p>\n                    </div>';
                                break;
                            case "CONFIG_ERROR":
                                n =
                                    '‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã<br>\n                    <div class="camera-instructions">\n                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.</p>\n                    </div>';
                                break;
                            default:
                                n = `‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${t}`;
                        }
                        (showOrderMessage(n, "error"),
                            (d.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"),
                            window.qrScannerManager &&
                            window.qrScannerManager.stopScanning().catch(() => { }));
                    }
                } else showOrderMessage("‚ùå QR —Å–∫–∞–Ω–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω", "error");
            }));
        const h = document.getElementById("manualTableBtn"),
            w = document.getElementById("manualTableNumber");
        async function b() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)
                    return {
                        available: !1,
                        reason: "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ",
                    };
                const e = (await navigator.mediaDevices.enumerateDevices()).filter(
                    (e) => "videoinput" === e.kind,
                );
                return 0 === e.length
                    ? { available: !1, reason: "–ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ" }
                    : { available: !0, devices: e };
            } catch (e) {
                return {
                    available: !1,
                    reason: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞–º–µ—Ä—ã: " + e.message,
                };
            }
        }
        (h &&
            w &&
            h.addEventListener("click", function () {
                const e = w.value.trim();
                !e || parseInt(e) < 1
                    ? showOrderMessage("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞", "error")
                    : (s && (s.value = e), c && (c.textContent = "–°—Ç–æ–ª ‚Ññ" + e), f());
            }),
            u &&
            u.addEventListener("click", function () {
                u &&
                    i &&
                    (navigator.geolocation
                        ? (m && m.classList.remove("hidden"),
                            (u.disabled = !0),
                            (u.textContent = "‚è≥"),
                            navigator.geolocation.getCurrentPosition(
                                (e) => {
                                    const { latitude: n, longitude: r } = e.coords;
                                    fetch(
                                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${r}&accept-language=ru`,
                                    )
                                        .then((e) => e.json())
                                        .then((e) => {
                                            const a = e.display_name || `${n}, ${r}`;
                                            ((i.value = a),
                                                (i.dataset.lat = n),
                                                (i.dataset.lon = r),
                                                m && m.classList.add("hidden"),
                                                t && a.trim() && (t.disabled = !1));
                                        })
                                        .catch((e) => {
                                            i.value = `${n.toFixed(6)}, ${r.toFixed(6)}`;
                                        })
                                        .finally(() => {
                                            ((u.disabled = !1), (u.textContent = "üìç"));
                                        });
                                },
                                (e) => {
                                    let t = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.";
                                    switch (e.code) {
                                        case e.PERMISSION_DENIED:
                                            t =
                                                '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ß—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å:\n\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∑–∞–º–∫–∞ (üîí) —Å–ª–µ–≤–∞ –æ—Ç –∞–¥—Ä–µ—Å–∞ —Å–∞–π—Ç–∞.\n2. –í —Ä–∞–∑–¥–µ–ª–µ "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è" –Ω–∞–π–¥–∏—Ç–µ "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å".\n3. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" —Å–Ω–æ–≤–∞.';
                                            break;
                                        case e.POSITION_UNAVAILABLE:
                                            t = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.";
                                            break;
                                        case e.TIMEOUT:
                                            t = "–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.";
                                    }
                                    (alert(t),
                                        m && m.classList.add("hidden"),
                                        (u.disabled = !1),
                                        (u.textContent = "üìç"));
                                },
                                { enableHighAccuracy: !0, timeout: 1e4, maximumAge: 0 },
                            ))
                        : alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º."));
            }),
            document.addEventListener("DOMContentLoaded", async function () {
                await b();
            }),
            t &&
            t.addEventListener("click", function () {
                if (!p)
                    return void showOrderMessage(
                        "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞",
                        "error",
                    );
                let e = "";
                if ("delivery" === p) {
                    if (((e = i ? i.value.trim() : ""), !e))
                        return void showOrderMessage(
                            "‚ùå –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏",
                            "error",
                        );
                } else if ("table" === p) {
                    if (((e = s ? s.value.trim() : ""), !e))
                        return void showOrderMessage(
                            "‚ùå –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å—Ç–æ–ª–∞",
                            "error",
                        );
                } else e = p;
                (localStorage.setItem("deliveryType", p),
                    localStorage.setItem("deliveryDetails", e),
                    g(),
                    f(),
                    setupCheckoutButton());
            }),
            n && n.addEventListener("click", g),
            r &&
            r.addEventListener("click", function (n) {
                (n.preventDefault(),
                    0 !== cart.getTotalCount()
                        ? ((p = null),
                            l.forEach((e) => e.classList.remove("active")),
                            i && (i.value = ""),
                            s && (s.value = ""),
                            c && (c.textContent = ""),
                            a && a.classList.add("hidden"),
                            o && o.classList.add("hidden"),
                            t && (t.disabled = !0),
                            f(),
                            e &&
                            ((e.style.display = "flex"),
                                (document.body.style.overflow = "hidden"),
                                a && a.classList.add("hidden"),
                                o && o.classList.add("hidden"),
                                m && m.classList.add("hidden"),
                                f()))
                        : showOrderMessage("‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!", "error"));
            }),
            document.addEventListener("click", function (e) {
                e.target.closest('.delivery-option[data-type="delivery"]') &&
                    setTimeout(function () {
                        "function" == typeof window.initAddressAutocomplete &&
                            window.initAddressAutocomplete();
                    }, 100);
            }));
        const I = document.getElementById("clear-cart-btn");
        (I &&
            I.addEventListener("click", function (e) {
                (e.preventDefault(), clearCart());
            }),
            (window.initAddressAutocomplete = function () {
                const e = document.getElementById("deliveryAddress");
                if (!e) return;
                if (e.classList.contains("address-autocomplete-initialized")) return;
                const t = document.createElement("div");
                function n(n) {
                    if (0 === n.length) return void (t.style.display = "none");
                    ((t.innerHTML = ""),
                        n.forEach((n) => {
                            const r = document.createElement("div");
                            ((r.textContent = n),
                                (r.style.cssText =
                                    "padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;"),
                                r.addEventListener(
                                    "mouseover",
                                    () => (r.style.background = "#f8f9fa"),
                                ),
                                r.addEventListener(
                                    "mouseout",
                                    () => (r.style.background = "white"),
                                ),
                                r.addEventListener("click", () => {
                                    ((e.value = n), (t.style.display = "none"));
                                }),
                                t.appendChild(r));
                        }),
                        (t.style.display = "block"));
                    const r = e.getBoundingClientRect();
                    ((t.style.top = r.bottom + window.scrollY + "px"),
                        (t.style.left = r.left + "px"),
                        (t.style.width = r.width + "px"));
                }
                ((t.className = "address-suggestions"),
                    (t.style.cssText =
                        "\n        position: absolute;\n        background: white;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        max-height: 200px;\n        overflow-y: auto;\n        z-index: 10000;\n        display: none;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n    "),
                    e.parentNode.appendChild(t),
                    e.addEventListener("input", function (e) {
                        const r = e.target.value.trim();
                        r.length < 2 ? (t.style.display = "none") : n([]);
                    }),
                    e.addEventListener("blur", function () {
                        setTimeout(() => {
                            t.style.display = "none";
                        }, 200);
                    }),
                    e.addEventListener("focus", function (e) {
                        const t = e.target.value.trim();
                        t.length >= 2 && n([]);
                    }),
                    e.classList.add("address-autocomplete-initialized"));
            }));
    }),
    document.addEventListener("click", (e) => {
        const t = e.target.closest(".checkout-btn");
        if (!t) return;
        const n = t.textContent.trim(),
            r = t.querySelector(".fa-redo");
        if (!n.includes("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å") && !r) return;
        (e.preventDefault(), e.stopPropagation());
        let a = t.closest(".repeat-order-form");
        if (
            (a || (a = t.closest("form")),
                a || (a = t.closest(".order-actions")?.querySelector("form")),
                !a)
        )
            return;
        const o = a.dataset.orderId || t.dataset.orderId;
        if (!o) return;
        if (!confirm("–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞–∫–∞–∑–∞ " + o + " –≤ –∫–æ—Ä–∑–∏–Ω—É?")) return;
        const i = t.innerHTML;
        ((t.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...'),
            (t.disabled = !0));
        const s = new FormData();
        (s.append("action", "repeat_order"),
            s.append("order_id", o),
            s.append(
                "csrf_token",
                document.querySelector('input[name="csrf_token"]')?.value || "",
            ),
            fetch("customer_orders.php", {
                method: "POST",
                body: s,
                headers: { "X-Requested-With": "XMLHttpRequest" },
            })
                .then((e) => {
                    const t = e.headers.get("content-type");
                    return t && t.includes("application/json")
                        ? e.json()
                        : e.text().then((e) => {
                            throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç");
                        });
                })
                .then((e) => {
                    if (!e.success)
                        throw new Error(e.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑");
                    ((cart.items = {}), (cart.products = {}));
                    for (const t in e.products) {
                        const n = e.products[t];
                        (cart.addProduct(
                            n.id,
                            n.name,
                            n.price,
                            n.image,
                            n.calories,
                            n.protein,
                            n.fat,
                            n.carbs,
                        ),
                            (cart.items[t] = e.cart[t]));
                    }
                    (localStorage.setItem("cart", JSON.stringify(cart.items)),
                        localStorage.setItem("products", JSON.stringify(cart.products)),
                        renderCartItems(cart.items, cart.products),
                        updateAllCartButtons(),
                        updateCartCounter(),
                        updateOrderSummary(),
                        "undefined" != typeof showNotification
                            ? showNotification("–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É", "success")
                            : alert("–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É"),
                        setTimeout(() => {
                            window.location.href = "cart.php";
                        }, 1e3));
                })
                .catch((e) => {
                    "undefined" != typeof showNotification
                        ? showNotification(
                            e.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞",
                            "error",
                        )
                        : alert("–û—à–∏–±–∫–∞: " + e.message);
                })
                .finally(() => {
                    ((t.innerHTML = i), (t.disabled = !1));
                }));
    }),
    document.addEventListener("DOMContentLoaded", initGuestModal));
