/* MenuLabus - Optimized */
document.addEventListener("DOMContentLoaded",()=>{initializeFileManager(),initializeDesignManager()});let currentFolder="",currentPath="",pathHistory=[];function initializeFileManager(){document.getElementById("browseImages")?.addEventListener("click",()=>browseFiles("images")),document.getElementById("browseFonts")?.addEventListener("click",()=>browseFiles("fonts")),document.getElementById("browseIcons")?.addEventListener("click",()=>browseFiles("icons")),document.getElementById("uploadFileBtn")?.addEventListener("click",uploadFile),document.getElementById("createFolderBtn")?.addEventListener("click",createFolder),document.getElementById("goBackBtn")?.addEventListener("click",goBack)}function browseFiles(e,t=""){currentFolder=e,currentPath=t,pathHistory=[],renderCurrentPath(),document.getElementById("fileBrowser").style.display="block",loadFiles(e,t)}function renderCurrentPath(){const e=currentFolder+(currentPath?"/"+currentPath:"");document.getElementById("currentFolder").textContent=e;const t=document.getElementById("goBackBtn");pathHistory.length?t.classList.add("visible"):t.classList.remove("visible")}function loadFiles(e,t=""){let n=`file-manager.php?action=list&folder=${encodeURIComponent(e)}`;t&&(n+=`&subfolder=${encodeURIComponent(t)}`),fetch(n).then(e=>e.json()).then(e=>{const t=document.getElementById("fileList");t.innerHTML="",e.items&&0!==e.items.length?(e.items.forEach(e=>{const n=document.createElement("div");n.className="file-item "+e.type,"folder"===e.type?n.innerHTML=`\n                        <span class="file-icon">üìÅ</span>\n                        <span class="file-name">${e.name}/</span>\n                        <div class="file-actions">\n                            <button class="file-open-btn" data-path="${e.path}">–û—Ç–∫—Ä—ã—Ç—å</button>\n                            <button class="file-delete-btn" data-path="${e.path}" data-type="folder">–£–¥–∞–ª–∏—Ç—å</button>\n                        </div>`:n.innerHTML=`\n                        <span class="file-icon">üìÑ</span>\n                        <span class="file-name">${e.name}</span>\n                        <div class="file-actions">\n                            <button class="file-delete-btn" data-path="${e.path}" data-type="file">–£–¥–∞–ª–∏—Ç—å</button>\n                        </div>`,t.appendChild(n)}),t.querySelectorAll(".file-open-btn").forEach(e=>e.addEventListener("click",()=>{pathHistory.push(currentPath),currentPath=e.dataset.path,renderCurrentPath(),loadFiles(currentFolder,currentPath)})),t.querySelectorAll(".file-delete-btn").forEach(e=>e.addEventListener("click",()=>deleteItem(currentFolder,e.dataset.path,e.dataset.type)))):t.innerHTML='<div class="file-item empty">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</div>'}).catch(e=>{document.getElementById("fileList").innerHTML='<div class="file-item error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'})}function goBack(){pathHistory.length&&(currentPath=pathHistory.pop(),renderCurrentPath(),loadFiles(currentFolder,currentPath))}function createFolder(){const e=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏:")?.trim();if(!e)return;if(!/^[a-zA-Z0-9_\- ]+$/.test(e))return void alert("–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª, –¥–µ—Ñ–∏—Å –∏–ª–∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ.");const t=document.querySelector('input[name="csrf_token"]')?.value||"";fetch("file-manager.php?action=create_folder",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:currentFolder,subfolder:currentPath,name:e,csrf_token:t})}).then(e=>e.json()).then(e=>{e.success?loadFiles(currentFolder,currentPath):alert("–û—à–∏–±–∫–∞: "+e.error)}).catch(()=>alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏"))}function deleteItem(e,t,n){if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${"folder"===n?"–ø–∞–ø–∫—É":"—Ñ–∞–π–ª"} ¬´${t}¬ª?`))return;const o=document.querySelector('input[name="csrf_token"]')?.value||"";fetch("file-manager.php?action=delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e,path:t,type:n,csrf_token:o})}).then(e=>e.json()).then(e=>{e.success?loadFiles(currentFolder,currentPath):alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: "+e.error)}).catch(()=>alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"))}function uploadFile(){const e=document.getElementById("fileUpload"),t=e.files;if(!t||0===t.length)return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");const n=document.querySelector(".upload-progress"),o=document.querySelector(".progress"),l=document.querySelector(".progress-text"),a=document.getElementById("uploadFileBtn");n.style.display="block",o.style.width="0%",l.textContent="0%",a.classList.add("uploading"),a.disabled=!0;let c=0,r=0,d=0;function i(){const e=c/t.length*100;o.style.width=e+"%",l.textContent=Math.round(e)+"%"}function s(){e.value="",n.style.display="none",a.classList.remove("uploading"),a.disabled=!1,loadFiles(currentFolder,currentPath)}Array.from(t).forEach(e=>{!function(e){const n=new FormData;n.append("file",e),n.append("folder",currentFolder),n.append("subfolder",currentPath),n.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||""),fetch("file-manager.php?action=upload",{method:"POST",body:n}).then(e=>e.json()).then(e=>{c++,i(),e.success?r++:d++,c===t.length&&(0===d?alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${r} —Ñ–∞–π–ª–æ–≤!`):alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${r} –∏–∑ ${t.length} —Ñ–∞–π–ª–æ–≤. –û—à–∏–±–æ–∫: ${d}`),s())}).catch(e=>{c++,d++,i(),c===t.length&&(alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${r} –∏–∑ ${t.length} —Ñ–∞–π–ª–æ–≤. –û—à–∏–±–æ–∫: ${d}`),s())})}(e)})}function formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}function initializeDesignManager(){initializeProjectNameManager(),(document.querySelector(".font-controls")||document.querySelector(".color-controls"))&&(loadFonts(),document.querySelectorAll(".font-override-checkbox").forEach(e=>{e.addEventListener("change",function(){const e=this.id.replace("Override","");document.getElementById(e).disabled=!this.checked})}),document.querySelectorAll('input[type="color"]').forEach(e=>{e.addEventListener("change",function(){const e=this.nextElementSibling;e&&e.classList.contains("color-value")&&(e.textContent=this.value)})}),document.getElementById("saveFontsBtn")?.addEventListener("click",saveFonts),document.getElementById("saveColorsBtn")?.addEventListener("click",saveColors),document.getElementById("resetDesignBtn")?.addEventListener("click",resetDesign),loadSavedDesign())}async function loadFonts(){try{const e=await fetch("file-manager.php?action=get_fonts"),t=await e.json();t.fonts&&(populateFontSelectors(t.fonts),applySavedFontSettings())}catch(e){populateFontSelectors({})}}function populateFontSelectors(e){[{id:"fontLogo",default:"Magistral"},{id:"fontText",default:"Euclid Circular A"},{id:"fontHeading",default:"TT Firs Neue"}].forEach(t=>{const n=document.getElementById(t.id);if(!n)return;const o=n.options[0],l=o?o.value:`'${t.default}', ${t.default.includes("Magistral")?"serif":"sans-serif"}`,a=o?o.textContent:`${t.default} (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)`;n.innerHTML="";const c=document.createElement("option");c.value=l,c.textContent=a,o&&o.dataset.file&&(c.dataset.file=o.dataset.file),n.appendChild(c),Object.entries(e).forEach(([e,o])=>{if(e===t.default)return;const l=document.createElement("option");l.value=`'${e}', ${e.includes("Magistral")?"serif":"sans-serif"}`,l.textContent=e,l.dataset.file=o,n.appendChild(l)}),n.value=c.value})}function applySavedFontSettings(){const e=localStorage.getItem("fontSettings");if(e){const t=JSON.parse(e);t.logo&&document.getElementById("fontLogoOverride")&&document.getElementById("fontLogo")&&(document.getElementById("fontLogoOverride").checked=!0,document.getElementById("fontLogo").disabled=!1,document.getElementById("fontLogo").value=t.logo),t.text&&document.getElementById("fontTextOverride")&&document.getElementById("fontText")&&(document.getElementById("fontTextOverride").checked=!0,document.getElementById("fontText").disabled=!1,document.getElementById("fontText").value=t.text),t.heading&&document.getElementById("fontHeadingOverride")&&document.getElementById("fontHeading")&&(document.getElementById("fontHeadingOverride").checked=!0,document.getElementById("fontHeading").disabled=!1,document.getElementById("fontHeading").value=t.heading),applyFontSettings(t)}}function saveFonts(){const e=document.getElementById("fontLogoOverride"),t=document.getElementById("fontLogo"),n=document.getElementById("fontTextOverride"),o=document.getElementById("fontText"),l=document.getElementById("fontHeadingOverride"),a=document.getElementById("fontHeading");if(!e||!n||!l)return;const c={logo:e.checked&&t?t.value:null,text:n.checked&&o?o.value:null,heading:l.checked&&a?a.value:null};localStorage.setItem("fontSettings",JSON.stringify(c)),applyFontSettings(c),alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")}function saveColors(){const e={};document.querySelectorAll('input[type="color"]').forEach(t=>{const n=t.dataset.var;e[n]=t.value}),fetch("/save-colors.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({colors:e})}).then(e=>e.json()).then(t=>{t.success?(localStorage.setItem("colorSettings",JSON.stringify(e)),applyColorSettings(e),alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ!")):alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: "+(t.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"))}).catch(e=>{alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤")})}function applyFontSettings(e){e.logo&&(loadFontFace(e.logo),document.documentElement.style.setProperty("--font-logo",e.logo)),e.text&&(loadFontFace(e.text),document.documentElement.style.setProperty("--font-text",e.text)),e.heading&&(loadFontFace(e.heading),document.documentElement.style.setProperty("--font-heading",e.heading))}function loadFontFace(e){const t=e.split("'")[1],n=document.querySelector(`select option[value="${CSS.escape(e)}"]`);if(n&&n.dataset.file&&!loadFonts.has(t)){const e=n.dataset.file,o=document.createElement("link");o.rel="stylesheet",o.href=`dynamic-fonts.php?font=${encodeURIComponent(t)}&file=${encodeURIComponent(e)}`,o.setAttribute("nonce","<?= $styleNonce ?>"),document.head.appendChild(o),loadFonts.add(t)}}function applyColorSettings(e){for(const[t,n]of Object.entries(e))document.documentElement.style.setProperty("--"+t,n)}function loadSavedDesign(){const e=localStorage.getItem("fontSettings");if(e){const t=JSON.parse(e);t.logo&&(document.getElementById("fontLogoOverride").checked=!0,document.getElementById("fontLogo").disabled=!1,document.getElementById("fontLogo").value=t.logo),t.text&&(document.getElementById("fontTextOverride").checked=!0,document.getElementById("fontText").disabled=!1,document.getElementById("fontText").value=t.text),t.heading&&(document.getElementById("fontHeadingOverride").checked=!0,document.getElementById("fontHeading").disabled=!1,document.getElementById("fontHeading").value=t.heading),applyFontSettings(t)}const t=localStorage.getItem("colorSettings");if(t){const e=JSON.parse(t);for(const[t,n]of Object.entries(e)){const e="color"+ucfirst(t.replace(/-/g,"")),o=document.getElementById(e);if(o){o.value=n;const e=o.nextElementSibling;e&&e.classList.contains("color-value")&&(e.textContent=n)}}applyColorSettings(e)}}function resetDesign(){confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∑–∞–π–Ω–∞ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?")&&(document.querySelectorAll(".font-override-checkbox").forEach(e=>{e.checked=!1}),document.querySelectorAll(".font-selector").forEach(e=>{e.disabled=!0,e.selectedIndex=0}),document.querySelectorAll('input[type="color"]').forEach(e=>{const t=getDefaultColorValue(e.dataset.var);e.value=t;const n=e.nextElementSibling;n&&n.classList.contains("color-value")&&(n.textContent=t)}),localStorage.removeItem("fontSettings"),localStorage.removeItem("colorSettings"),document.documentElement.style="",alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!"))}function ucfirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}function getDefaultColorValue(e){return{"primary-color":"#cd1719","secondary-color":"#121212","primary-dark":"#000000","accent-color":"#db3a34","text-color":"#333333",acception:"#2c83c2","light-text":"#555555","bg-light":"#f9f9f9",white:"#ffffff",agree:"#4CAF50",procces:"#ff9321",brown:"#712121"}[e]||"#000000"}function initializeProjectNameManager(){const e=document.getElementById("projectName"),t=document.getElementById("saveProjectNameBtn");e&&t&&(loadProjectName(),t.addEventListener("click",saveProjectName));const n=localStorage.getItem("projectName");n&&!document.getElementById("projectName")&&applyProjectName(n)}function loadProjectName(){const e=localStorage.getItem("projectName"),t=document.getElementById("projectName");t&&e&&(t.value=e)}function saveProjectName(){const e=document.getElementById("projectName");if(!e)return;const t=e.value.trim();t?(localStorage.setItem("projectName",t),fetch("save-project-name.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"name="+encodeURIComponent(t)}).then(e=>e.json()).then(e=>{e.success?(applyProjectName(t),alert("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")):alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: "+(e.error||"Unknown error"))}).catch(e=>{applyProjectName(t),alert("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏)")})):alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞")}function applyProjectName(e){const t=document.title;t.includes("|")?document.title=e+t.substring(t.indexOf("|")):document.title=e;const n=document.querySelector(".logo a");n&&!n.querySelector("img")&&(n.textContent=e),document.querySelectorAll("[data-project-name]").forEach(t=>{t.textContent=e}),document.documentElement.setAttribute("data-project-name",e);const o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);let l;for(;l=o.nextNode();)l.nodeValue.includes("labus")&&(l.nodeValue=l.nodeValue.replace(/labus/g,e)),l.nodeValue.includes("labus")&&(l.nodeValue=l.nodeValue.replace(/labus/g,e))}function updateAllProjectNameReferences(e){document.querySelectorAll("[data-project-name]").forEach(t=>{t.textContent=e}),document.querySelectorAll(".project-name").forEach(t=>{t.textContent=e});const t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);let n;for(;n=t.nextNode();)n.nodeValue.includes("labus")&&(n.nodeValue=n.nodeValue.replace(/labus/g,e))}