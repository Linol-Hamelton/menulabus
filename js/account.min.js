/* MenuLabus - Optimized */
function toggleOrderDetails(t){const e=t.closest(".order-item").querySelector(".order-items"),o=t.querySelector(".order-toggle-icon")||t.querySelector(".employee-toggle-icon"),a=t.classList.toggle("active");e.style.display=a?"block":"none",o&&(o.classList.toggle("fa-chevron-down",!a),o.classList.toggle("fa-chevron-up",a))}function initOrderTabs(){const t=document.querySelectorAll(".tab-btn");t.forEach(e=>{e.addEventListener("click",function(){t.forEach(t=>t.classList.remove("active")),this.classList.add("active");const e=this.dataset.tab;document.cookie=`activeOrderTab=${e}; path=/; max-age=31536000`,document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")}),document.getElementById(e)?.classList?.add("active")})})}document.addEventListener("DOMContentLoaded",function(){document.addEventListener("click",function(t){t.target.closest("[data-toggle-order]")&&toggleOrderDetails(t.target.closest("[data-toggle-order]"))})}),document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".tab-btn");t.forEach(e=>{e.addEventListener("click",function(){t.forEach(t=>t.classList.remove("active")),this.classList.add("active");const e=this.dataset.tab;document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")}),document.getElementById(e)?.classList?.add("active")})})}),document.addEventListener("DOMContentLoaded",function(){initOrderTabs();const t=getCookie("activeOrderTab")||"all",e=document.querySelector(`.tab-btn[data-tab="${t}"]`);e&&e.click()}),document.addEventListener("click",function(t){const e=t.target.closest(".status-btn, .status-btn-r");if(!e)return;t.preventDefault();const o=e.dataset.action,a=e.dataset.orderId,n=e.dataset.currentStatus;"update_status"===o?handleEmployeeStatusUpdate(a,n,e):"reject"===o&&handleEmployeeReject(a,e)});const EmployeeTabManager={save(t){localStorage.setItem("activeOrderTab",t),document.cookie=`activeOrderTab=${t}; path=/; max-age=31536000`},load:()=>localStorage.getItem("activeOrderTab")||"Приём",switch(t){document.querySelectorAll(".tab-btn").forEach(e=>e.classList.toggle("active",e.dataset.tab===t)),document.querySelectorAll(".tab-content").forEach(e=>e.classList.toggle("active",e.id===t)),this.save(t)},init(){const t=this.load();this.switch(t)}},EmployeeAPI={async update(t,e){const o=document.querySelector('input[name="csrf_token"]')?.value;if(!o)throw new Error("CSRF token not found");try{const a=await fetch("update_order_status.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({csrf_token:o,order_id:t,action:e})});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(!n.success)throw new Error(n.error||"Unknown error");return n}catch(t){throw t}}};function getEmployeeButtonText(t){return{"Приём":"На кухню","готовим":"В доставку","доставляем":"Принято","завершён":"Завершено","отказ":"Отказано"}[t]||t}async function handleEmployeeStatusUpdate(t,e,o){if(!confirm("Изменить статус заказа?"))return;o.closest(".order-item"),o.closest(".update-order-form"),o.disabled=!0;const a=o.innerHTML;o.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{await EmployeeAPI.update(t,"update_status");const e=window.scrollY,o=document.querySelector(".tab-btn.active")?.dataset.tab;if(await refreshEmployeeOrders(),o){const t=document.querySelector(`.tab-btn[data-tab="${o}"]`),e=document.getElementById(o);t&&t.classList.add("active"),e&&e.classList.add("active")}setTimeout(()=>{window.scrollTo(0,e)},100),showNotification("Статус обновлён","success")}catch(t){showNotification(`Ошибка: ${t.message}`,"error"),o.disabled=!1,o.innerHTML=a}}async function handleEmployeeReject(t,e){if(!confirm("Отказать в заказе?"))return;e.closest(".order-item"),e.disabled=!0;const o=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{await EmployeeAPI.update(t,"reject");const e=window.scrollY,o=document.querySelector(".tab-btn.active")?.dataset.tab;if(await refreshEmployeeOrders(),o){const t=document.querySelector(`.tab-btn[data-tab="${o}"]`),e=document.getElementById(o);t&&t.classList.add("active"),e&&e.classList.add("active")}setTimeout(()=>{window.scrollTo(0,e)},100),showNotification("Заказ отклонён","success")}catch(t){showNotification(t.message,"error"),e.disabled=!1,e.innerHTML=o}}async function refreshEmployeeOrders(){return new Promise(t=>{fetch(location.href).then(t=>t.text()).then(e=>{const o=(new DOMParser).parseFromString(e,"text/html").querySelector(".account-sections"),a=document.querySelector(".account-sections");o&&a&&(a.outerHTML=o.outerHTML),reattachEventListeners(),t()}).catch(e=>{t()})})}function reattachEventListeners(){document.querySelectorAll(".status-btn, .status-btn-r").forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=this.dataset.action,o=this.dataset.orderId,a=this.dataset.currentStatus;"update_status"===e?handleEmployeeStatusUpdate(o,a,this):"reject"===e&&handleEmployeeReject(o,this)})}),document.querySelectorAll("[data-toggle-order]").forEach(t=>{t.addEventListener("click",function(){toggleOrderDetails(this)})});const t=document.querySelectorAll(".tab-btn");t.forEach(e=>{e.addEventListener("click",function(){t.forEach(t=>t.classList.remove("active")),this.classList.add("active");const e=this.dataset.tab;document.cookie=`activeOrderTab=${e}; path=/; max-age=31536000`,document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")});const o=document.getElementById(e);o&&o.classList.add("active")})})}function initEmployeePage(){document.querySelector(".employee-page")&&(EmployeeTabManager.init(),document.querySelectorAll(".update-order-form").forEach(t=>{t.addEventListener("submit",handleEmployeeStatusUpdate)}),document.querySelectorAll(".status-btn-r").forEach(t=>{t.addEventListener("click",handleEmployeeReject)}),document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",()=>EmployeeTabManager.switch(t.dataset.tab))}))}function showNotification(t,e="info"){const o=document.createElement("div");o.className=`notification ${e}`,o.textContent=t,o.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 12px 20px;\n        border-radius: 4px;\n        color: white;\n        z-index: 10000;\n        opacity: 0;\n        transform: translateX(100%);\n        transition: opacity 0.3s, transform 0.3s;\n    ";const a={success:"background-color: #4CAF50;",error:"background-color: #f44336;",info:"background-color: #2196F3;",warning:"background-color: #ff9800;"};o.style.cssText+=a[e]||a.info,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateX(0)"},10),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(100%)",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)},3e3)}document.addEventListener("DOMContentLoaded",function(){initEmployeePage()});(function(){
  'use strict';
  var lockMs=1200;
  function lock(btn){
    if(!btn){return false;}
    var now=Date.now();
    var until=Number(btn.dataset.clickLockUntil||0);
    if(until>now){return true;}
    btn.dataset.clickLockUntil=String(now+lockMs);
    return false;
  }
  document.addEventListener('click',function(ev){
    var btn=ev.target.closest('.status-btn, .status-btn-r');
    if(!btn){return;}
    if(lock(btn)){
      ev.preventDefault();
      ev.stopImmediatePropagation();
      return false;
    }
  },true);
})();
(function(){
  'use strict';
  var lockMs=1400;
  document.addEventListener('click',function(ev){
    var btn=ev.target.closest('.status-btn, .status-btn-r');
    if(!btn){return;}

    var now=Date.now();
    var until=Number(btn.dataset.hardLockUntil||0);
    if(until>now){
      ev.preventDefault();
      ev.stopImmediatePropagation();
      return false;
    }

    btn.dataset.hardLockUntil=String(now+lockMs);
    ev.preventDefault();
    ev.stopImmediatePropagation();

    var action=btn.dataset.action;
    var orderId=btn.dataset.orderId;
    var currentStatus=btn.dataset.currentStatus;

    if(action==='update_status' && typeof window.handleEmployeeStatusUpdate==='function'){
      window.handleEmployeeStatusUpdate(orderId,currentStatus,btn);
      return;
    }

    if(action==='reject' && typeof window.handleEmployeeReject==='function'){
      window.handleEmployeeReject(orderId,btn);
      return;
    }
  },true);
})();
