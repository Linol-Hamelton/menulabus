/* MenuLabus - Optimized */
class VersionChecker{constructor(){this.currentVersion=localStorage.getItem("app_version")||"1.0.0",this.lastCheck=parseInt(localStorage.getItem("last_version_check")||0),this.checkInterval=36e5,this.isUpdating=!1,this.serviceWorkerSupported="serviceWorker"in navigator}async checkVersion(){if(this.isUpdating)return!1;const e=Date.now();if(e-this.lastCheck<this.checkInterval)return!1;try{const t=await fetch("/version.json?t="+e);if(!t.ok)throw new Error("Version check failed");const s=await t.json(),n=s.version;return this.compareVersions(n,this.currentVersion)>0?(this.showUpdatePrompt(n,s.changelog,s.critical||!1),!0):(localStorage.setItem("last_version_check",e.toString()),!1)}catch(e){return!1}}compareVersions(e,t){const s=e.split(".").map(Number),n=t.split(".").map(Number);for(let e=0;e<Math.max(s.length,n.length);e++){const t=s[e]||0,r=n[e]||0;if(t!==r)return t>r?1:-1}return 0}showUpdatePrompt(e,t,s=!1){const n=document.createElement("div");n.className="version-update-modal";const r=s?"":'<button class="btn-update-later">–ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ</button>';n.innerHTML=`\n            <div class="version-update-content">\n                <h3 class="${s?"critical-update":"regular-update"}">\n                    ${s?"üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï":"üîÑ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"}\n                </h3>\n                <p>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong>${this.currentVersion}</strong></p>\n                <p>–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <strong>${e}</strong></p>\n                \n                ${t?`\n                <div class="changelog">\n                    <strong>–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:</strong>\n                    <div>${t}</div>\n                </div>`:""}\n                \n                <div class="version-buttons">\n                    <button class="btn-update-now ${s?"critical-btn":""}">–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å</button>\n                    ${r}\n                </div>\n            </div>\n        `,document.body.insertAdjacentElement("afterbegin",n),n.querySelector(".btn-update-now").addEventListener("click",()=>{this.performUpdate(),n.remove()}),s||n.querySelector(".btn-update-later").addEventListener("click",()=>{localStorage.setItem("last_version_check",(Date.now()-this.checkInterval+9e5).toString()),n.remove()}),s&&(n.style.pointerEvents="all",n.addEventListener("click",e=>e.stopPropagation()))}async performUpdate(){this.isUpdating=!0;try{this.showUpdateInProgress(),await fetch("/clear-cache.php?t="+Date.now(),{cache:"no-store"}),await this.unregisterServiceWorker(),await this.clearAllCaches();const e=await fetch("/version.json?t="+Date.now(),{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},cache:"no-store"});if(e.ok){const t=await e.json();localStorage.setItem("app_version",t.version)}localStorage.setItem("last_version_check",Date.now().toString()),setTimeout(()=>{window.location.href=window.location.origin+"?force_reload="+Date.now()},2e3)}catch(e){this.isUpdating=!1,this.showUpdateError()}}async unregisterServiceWorker(){if(this.serviceWorkerSupported)try{const e=await navigator.serviceWorker.getRegistration();e&&await e.unregister()}catch(e){}}async updateServiceWorker(){if(this.serviceWorkerSupported)try{const e=await navigator.serviceWorker.getRegistration();e&&(e.active&&e.active.postMessage({type:"SKIP_WAITING"}),await e.update())}catch(e){}}async clearAllCaches(){if("caches"in window)try{const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}catch(e){}if(this.serviceWorkerSupported)try{const e=await navigator.serviceWorker.getRegistration();e&&e.active&&e.active.postMessage({type:"CLEAR_CACHE"})}catch(e){}const e=["user_data","auth_token","settings","app_version","last_version_check"];Object.keys(localStorage).forEach(t=>{e.includes(t)||localStorage.removeItem(t)}),sessionStorage.clear(),await this.clearBrowserCache()}async clearBrowserCache(){const e=document.createElement("iframe");e.style.display="none",document.body.appendChild(e),["/","/index.html","/css/fa-styles.css","/css/account-styles.css","/css/fa-purged.css","/js/app.js","/js/cart.js","/js/security.js","/js/account.js","/js/ws-orders.js","/js/version-checker.js"].forEach(t=>{e.src=t+"?cache_bust="+Date.now()+Math.random()}),setTimeout(()=>{document.body.removeChild(e)},1e3)}showUpdateInProgress(){const e=document.createElement("div");e.className="update-progress",e.innerHTML='\n            <div class="progress-content">\n                <div class="spinner"></div>\n                <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>\n                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>\n            </div>\n        ',document.body.appendChild(e)}showUpdateError(){const e=document.createElement("div");e.className="update-error",e.innerHTML='\n            <h3>‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>\n            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ä—É—á–Ω—É—é.</p>\n            <button onclick="window.location.reload(true)">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>\n        ',document.body.appendChild(e)}init(){this.checkVersion(),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.checkVersion()}),window.addEventListener("online",()=>{this.checkVersion()}),setInterval(()=>{this.checkVersion()},72e5)}}"undefined"!=typeof window&&(window.versionChecker=new VersionChecker,document.addEventListener("DOMContentLoaded",()=>{window.versionChecker.init()}));