# FastCGI Cache zone definition (уникальный путь для menu.labus.pro)
fastcgi_cache_path /var/cache/nginx/fastcgi_cafe levels=1:2 keys_zone=CAFECACHE:100m inactive=60m max_size=1g;

# PHP-FPM upstream для menu.labus.pro
upstream php_fpm_backend {
    server unix:/var/run/menu.labus.pro.sock;
    # Alternative TCP connection:
    # server 127.0.0.1:9000;
}

server {
    listen 62.217.178.117:443 ssl http2;
    server_name menu.labus.pro;

    ssl_certificate "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.crt";
    ssl_certificate_key "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.key";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    charset utf-8;
    gzip on;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/css text/xml application/javascript text/plain application/json image/svg+xml image/x-icon application/xml+rss application/atom+xml;
    gzip_comp_level 6;
    gzip_min_length 1024;

    set $root_path /var/www/labus_pro_usr/data/www/menu.labus.pro;
    root $root_path;
    disable_symlinks if_not_owner from=$root_path;

    # Default landing: redirect / -> /menu.php (keep query string)
    location = / {
        return 302 /menu.php$is_args$args;
    }

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;

    # FastCGI Cache skip logic (оптимизированная)
    set $skip_cache 0;
    if ($request_method = POST) { set $skip_cache 1; }
    if ($http_cookie ~* "PHPSESSID") { set $skip_cache 1; }
    if ($request_uri ~* "/admin-menu|/owner|/employee|/account|monitor|clear-cache|api|ws-poll|orders-sse") { set $skip_cache 1; }
    # Динамические страницы с параметрами не кэшируем
    if ($args) { set $skip_cache 1; }

    # Все старые location сохранены
    location = /version.json {
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header Cache-Control "no-cache, must-revalidate";
        add_header Pragma "no-cache";
        add_header Access-Control-Allow-Origin "https://menu.labus.pro";
        add_header Access-Control-Allow-Credentials "true";
        expires 0;
        try_files $uri =404;
    }

    location = /sw.js {
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header Content-Type "application/javascript";
        add_header Service-Worker-Allowed "/";
        expires 0;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        try_files $uri =404;
    }

    location = /manifest.webmanifest {
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header Content-Type "application/manifest+json";
        add_header Cache-Control "public, max-age=3600, must-revalidate";
        try_files $uri =404;
    }

    location = /offline.html {
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header Content-Type "text/html; charset=utf-8";
        add_header Cache-Control "public, max-age=3600, must-revalidate";
        try_files $uri =404;
    }

    # PHP-FPM status (localhost only)
    location = /fpm-status {
        allow 127.0.0.1;
        allow 62.217.178.117;
        deny all;
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /fpm-status;
        fastcgi_param SCRIPT_NAME /fpm-status;
        fastcgi_param PATH_INFO "";
        fastcgi_pass php_fpm_backend;
    }

    # Block index optimizer from public access
    location = /db-indexes-optimizer.php {
        return 404;
    }

    location ~* ^/image/.+\.(jpg|jpeg|png|gif|webp|svg|ico)$ {
        valid_referers none blocked server_names *.menu.labus.pro;
        if ($invalid_referer) { return 403; }
        if ($http_referer = '') { return 403; }
        alias /var/www/labus_pro_usr/data/www/menu.labus.pro;
        add_header Cache-Control "public, immutable, max-age=31536000" always;
        expires 1y;
        try_files $uri =404;
    }

    location = /manifest.json {
        return 301 /manifest.webmanifest;
    }

    location ~* \.webmanifest$ {
        add_header Content-Type application/manifest+json;
        add_header Cache-Control "public, max-age=3600";
        try_files $uri =404;
    }

    location /image/ {
        alias /var/www/labus_pro_usr/data/www/menu.labus.pro/image/;
        try_files $uri =404;
    }

    location ~* \.(html|jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpeg|avi|zip|gz|bz2|rar|swf|ico|7z|doc|docx|map|ogg|otf|pdf|tff|tif|txt|wav|webp|woff|woff2|xls|xlsx|xml)$ {
        expires 365d;
        add_header Cache-Control "public, immutable";
        try_files $uri $uri/ =404;
    }

    # API endpoints
    location ~ ^/(save-colors|create_new_order|update_order_status) {
        fastcgi_pass php_fpm_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;
    }

    location = /orders-sse.php {
        fastcgi_pass php_fpm_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;
        fastcgi_buffering off;
        fastcgi_cache off;
        gzip off;
        add_header Cache-Control "no-store";
        add_header X-Accel-Buffering "no";
    }

    # Auth endpoints
    location ~ ^/(auth|login|logout|verify|password-reset) {
        fastcgi_pass php_fpm_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;
    }

    location = /menu.php {
        set $menu_script /menu.php;
        if ($http_cookie !~* "PHPSESSID") { set $menu_script /menu-public.php; }

        # FastCGI to PHP-FPM
        fastcgi_pass php_fpm_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$menu_script;
        fastcgi_param SCRIPT_NAME $menu_script;
        include /etc/nginx/fastcgi_params;

        # FastCGI Cache (оптимизированные параметры)
        fastcgi_cache CAFECACHE;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_valid 200 302 60m;
        fastcgi_cache_valid 301 24h;
        fastcgi_cache_valid any 5m;
        fastcgi_cache_key "$scheme$request_method$host$request_uri";
        fastcgi_cache_use_stale error timeout invalid_header http_500 http_503 updating;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock on;
        fastcgi_cache_lock_timeout 2s;
        fastcgi_cache_revalidate on;
        fastcgi_cache_min_uses 2;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location / {
        # FastCGI to PHP-FPM
        fastcgi_pass php_fpm_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;

        # FastCGI Cache (оптимизированные параметры)
        fastcgi_cache CAFECACHE;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_valid 200 302 60m;   # увеличено с 10м
        fastcgi_cache_valid 301 24h;       # увеличено с 1ч
        fastcgi_cache_valid any 5m;        # увеличено с 1м
        fastcgi_cache_key "$scheme$request_method$host$request_uri";  # убрали PHPSESSID
        fastcgi_cache_use_stale error timeout invalid_header http_500 http_503 updating;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock on;
        fastcgi_cache_lock_timeout 2s;     # уменьшено с 5с
        fastcgi_cache_revalidate on;
        fastcgi_cache_min_uses 2;          # новый параметр

        # Security headers (дублируем из server, потому что add_header сбрасывает наследование)
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # include "/etc/nginx/fastpanel2-sites/labus_pro_usr/menu.labus.pro.includes";
    # include /etc/nginx/fastpanel2-includes/*.conf;

    error_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.error.log;
    access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.access.log;
}

server {
    server_name menu.labus.pro;
    listen 62.217.178.117:80;
    return 301 https://$host$request_uri;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    error_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.error.log;
    access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.access.log;
}

server {
    listen 62.217.178.117:80;
    listen 62.217.178.117:443 ssl http2;
    server_name www.menu.labus.pro;
    ssl_certificate "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.crt";
    ssl_certificate_key "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.key";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    return 301 $scheme://menu.labus.pro$request_uri;
    error_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.error.log;
    access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.access.log;
}
