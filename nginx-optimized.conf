## nginx-optimized.conf
## Copy of intended Nginx config for menu.labus.pro.
## Goal: max performance + stability (RPS/p95) WITHOUT weakening security.
##
## IMPORTANT (placement rules):
## - `fastcgi_cache_path`, `upstream`, `map` must be inside `http {}`.
## - `server {}` blocks also belong inside `http {}`.
## - If you use FastPanel includes, translate these blocks accordingly.
##
## Why this file exists:
## - Split PHP-FPM pools: web / api / sse (so SSE does not steal web/API workers)
## - Add microcache for public API: /api/v1/menu.php (burst protection)
## - Cache ONLY the anonymous menu HTML (not the whole site) to avoid leaking Set-Cookie/user state.
## - Keep security headers strict (CSP is handled by PHP with per-request nonces).

# -------------------------------------------------------------------
# http{}: FastCGI cache zones
# -------------------------------------------------------------------
fastcgi_cache_path /var/cache/nginx/fastcgi_cafe levels=1:2 keys_zone=CAFECACHE:100m inactive=60m max_size=1g;
fastcgi_cache_path /var/cache/nginx/fastcgi_api_micro levels=1:2 keys_zone=APIMICRO:50m inactive=30s max_size=1g;

# -------------------------------------------------------------------
# http{}: Upstreams (web/api/sse pool split)
# -------------------------------------------------------------------
upstream php_fpm_backend { server unix:/var/run/menu.labus.pro.sock; }
upstream php_fpm_api     { server unix:/var/run/menu.labus.pro-api.sock; }
upstream php_fpm_sse     { server unix:/var/run/menu.labus.pro-sse.sock; }

# -------------------------------------------------------------------
# http{}: Microcache bypass (never cache if Authorization/PHPSESSID present)
# -------------------------------------------------------------------
map $http_authorization $api_has_auth { default 1; "" 0; }
map $http_cookie        $api_has_sess { default 0; "~*PHPSESSID=" 1; }
map "$api_has_auth$api_has_sess" $api_skip_microcache { default 1; "00" 0; }

# For truly public endpoints (like /api/v1/menu.php), we only bypass on Authorization.
# Cookies are ignored, because API ctx does not use sessions and menu payload must be identical.
map $http_authorization $api_skip_microcache_public { default 1; "" 0; }

# Benchmark/diagnostics: allow forcing cache bypass explicitly without relying on Authorization.
# Use header `X-Bypass-Cache: 1` in wrk/curl when you want to measure real backend cost.
map $http_x_bypass_cache $api_skip_microcache_benchmark { default 0; "1" 1; }

# -------------------------------------------------------------------
# http{}: Access log (perf diagnostics)
# -------------------------------------------------------------------
# Keep FastPanel's existing access log as-is, but write a second, focused perf log with upstream timings.
# Important: /api/v1/menu.php can be extremely high RPS on cache HIT, so we only perf-log it when you
# explicitly opt-in via request header `X-Perf: 1` (use it in curl/wrk while benchmarking).
log_format menu_perf '[$time_iso8601] host=$host ip=$remote_addr '
                    'req="$request" st=$status bytes=$body_bytes_sent '
                    'rt=$request_time '
                    'uct=$upstream_connect_time uht=$upstream_header_time urt=$upstream_response_time '
                    'uaddr=$upstream_addr ust=$upstream_status cache=$upstream_cache_status '
                    'conn=$connection connreq=$connection_requests '
                    'ua="$http_user_agent"';

map $http_x_perf $menu_perf_log {
    default 0;
    "1"     1;
}

server {
    listen 62.217.178.117:443 ssl http2;
    server_name menu.labus.pro;

    ssl_certificate "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.crt";
    ssl_certificate_key "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.key";

    # HSTS (keep preload only if you're sure all subdomains are HTTPS forever).
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    charset utf-8;

    gzip on;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/css text/xml application/javascript text/plain application/json image/svg+xml image/x-icon application/xml+rss application/atom+xml;
    # Perf: gzip level 2 is usually a better CPU/latency tradeoff for high RPS.
    gzip_comp_level 2;
    gzip_min_length 1024;
    gzip_vary on;

    # Perf: reduce syscalls for static file lookups.
    # (Safe: does not change access checks, only caches file metadata.)
    open_file_cache max=10000 inactive=60s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Perf: keep client connections warm (good for mobile/HTTP2 bursts).
    keepalive_timeout 30s;
    keepalive_requests 1000;

    set $root_path /var/www/labus_pro_usr/data/www/menu.labus.pro;
    root $root_path;
    disable_symlinks if_not_owner from=$root_path;

    # Default landing: / -> /menu.php (keep query string)
    location = / {
        return 302 /menu.php$is_args$args;
    }

    # Baseline security headers for ALL responses (CSP is emitted by PHP per request).
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header X-Cache-Status $upstream_cache_status always;

    # Cache skip logic (defensive; do not cache sessions/admin/API/SSE).
    set $skip_cache 0;
    if ($request_method = POST) { set $skip_cache 1; }
    if ($http_cookie ~* "PHPSESSID") { set $skip_cache 1; }
    if ($request_uri ~* "/admin-menu|/owner|/employee|/account|monitor|clear-cache|api|ws-poll|orders-sse") { set $skip_cache 1; }
    if ($args) { set $skip_cache 1; }

    # -------------------------------------------------------------------
    # Static assets
    # -------------------------------------------------------------------
    location ^~ /webfonts/ {
        add_header Cache-Control "public, immutable, max-age=31536000" always;
        expires 1y;
        try_files $uri =404;
    }

    location ~* \.(?:css|js|png|jpg|jpeg|gif|webp|svg|ico|woff|woff2|ttf|otf|map)$ {
        add_header Cache-Control "public, immutable, max-age=31536000" always;
        expires 1y;
        try_files $uri =404;
    }

    # -------------------------------------------------------------------
    # PWA files
    # -------------------------------------------------------------------
    location = /version.json {
        add_header Cache-Control "no-cache, must-revalidate" always;
        add_header Pragma "no-cache" always;
        expires 0;
        try_files $uri =404;
    }

    location = /sw.js {
        add_header Content-Type "application/javascript" always;
        add_header Service-Worker-Allowed "/" always;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        expires 0;
        try_files $uri =404;
    }

    location = /manifest.webmanifest {
        add_header Content-Type "application/manifest+json" always;
        add_header Cache-Control "public, max-age=3600, must-revalidate" always;
        try_files $uri =404;
    }

    location = /manifest.json {
        return 301 /manifest.webmanifest;
    }

    location = /offline.html {
        add_header Content-Type "text/html; charset=utf-8" always;
        add_header Cache-Control "public, max-age=3600, must-revalidate" always;
        try_files $uri =404;
    }

    # -------------------------------------------------------------------
    # php-fpm status pages (restrict access)
    # -------------------------------------------------------------------
    location = /fpm-status {
        allow 127.0.0.1;
        allow 62.217.178.117;
        deny all;
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /fpm-status;
        fastcgi_param SCRIPT_NAME /fpm-status;
        fastcgi_param PATH_INFO "";
        fastcgi_pass php_fpm_backend;
    }

    location = /fpm-status-api {
        allow 127.0.0.1;
        allow 62.217.178.117;
        deny all;
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /fpm-status-api;
        fastcgi_param SCRIPT_NAME /fpm-status-api;
        fastcgi_param PATH_INFO "";
        fastcgi_pass php_fpm_api;
    }

    location = /fpm-status-sse {
        allow 127.0.0.1;
        allow 62.217.178.117;
        deny all;
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /fpm-status-sse;
        fastcgi_param SCRIPT_NAME /fpm-status-sse;
        fastcgi_param PATH_INFO "";
        fastcgi_pass php_fpm_sse;
    }

    # Block optimizer/debug endpoints
    location = /db-indexes-optimizer.php { return 404; }

    # -------------------------------------------------------------------
    # API v1 (default: no cache)
    # -------------------------------------------------------------------
    location ^~ /api/v1/ {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm_api;
        fastcgi_keep_conn on;
        fastcgi_cache off;
    }

    # Microcache (public only): /api/v1/menu.php
    location = /api/v1/menu.php {
        # Perf diagnostics (opt-in): add `X-Perf: 1` to log upstream timings for this endpoint.
        access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.perf.access.log menu_perf if=$menu_perf_log;

        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm_api;
        fastcgi_keep_conn on;

        # Hardening/perf: menu is public and must not vary by session cookies.
        # This prevents accidental session coupling and enables microcache even if browser sends PHPSESSID.
        fastcgi_param HTTP_COOKIE "";

        # Menu is truly public: make it cacheable even if a client mistakenly sends Authorization.
        # Also do not forward Authorization to PHP to prevent accidental user-specific behavior.
        fastcgi_param HTTP_AUTHORIZATION "";

        # Burst protection layer (server-side), ignore upstream cache headers/cookies.
        fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
        fastcgi_hide_header Set-Cookie;

        fastcgi_cache APIMICRO;
        # Default: cache. Benchmark-only bypass via `X-Bypass-Cache: 1`.
        fastcgi_cache_bypass $api_skip_microcache_benchmark;
        fastcgi_no_cache $api_skip_microcache_benchmark;
        # Perf: slightly longer TTL reduces backend refresh frequency and p99 spikes.
        fastcgi_cache_valid 200 5s;

        # CORS depends on Origin: include it in cache key to avoid mismatches.
        fastcgi_cache_key "$scheme$request_method$host$request_uri|$http_origin";

        fastcgi_cache_lock on;
        fastcgi_cache_lock_timeout 1s;
        # Safety: do not hold the lock too long if upstream stalls.
        fastcgi_cache_lock_age 5s;
        fastcgi_cache_use_stale updating error timeout invalid_header http_500 http_503;
        fastcgi_cache_background_update on;
    }

    # -------------------------------------------------------------------
    # SSE / long-poll (isolated pool, buffering off)
    # -------------------------------------------------------------------
    location = /orders-sse.php {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm_sse;
        fastcgi_keep_conn on;

        fastcgi_buffering off;
        fastcgi_cache off;
        gzip off;

        # SSE must have Content-Type: text/event-stream.
        # Let upstream (PHP) set it; keep a fallback for safety.
        default_type text/event-stream;

        add_header X-Accel-Buffering "no" always;
        add_header Cache-Control "no-store" always;

        fastcgi_read_timeout 3600s;
        fastcgi_send_timeout 3600s;
    }

    location = /ws-poll.php {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm_sse;
        fastcgi_keep_conn on;

        fastcgi_buffering off;
        fastcgi_cache off;
        gzip off;

        add_header X-Accel-Buffering "no" always;
        add_header Cache-Control "no-store" always;
    }

    # -------------------------------------------------------------------
    # /menu.php: cache ONLY anonymous menu HTML (via /menu-public.php)
    # -------------------------------------------------------------------
    location = /menu.php {
        set $menu_script /menu.php;
        if ($http_cookie !~* "PHPSESSID") { set $menu_script /menu-public.php; }

        # Perf diagnostics (opt-in): add `X-Perf: 1` to log upstream timings for this endpoint.
        access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.perf.access.log menu_perf if=$menu_perf_log;

        # CSP: Observatory checks /menu.php. Defining CSP inside this location avoids breaking other
        # pages that may still contain inline scripts/styles.
        #
        # Note: once a location has any `add_header`, headers from `server {}` are NOT inherited.
        # We therefore repeat all baseline security headers here.
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header X-Cache-Status $upstream_cache_status always;
        add_header Content-Security-Policy "default-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; object-src 'none'; frame-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' https://nominatim.openstreetmap.org; manifest-src 'self'; worker-src 'self' blob:; media-src 'self' blob:" always;

        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$menu_script;
        fastcgi_param SCRIPT_NAME $menu_script;
        fastcgi_pass php_fpm_backend;
        fastcgi_keep_conn on;

        fastcgi_cache CAFECACHE;
        fastcgi_cache_bypass $skip_cache;
        # Never cache responses that set cookies (security/correctness).
        fastcgi_no_cache $skip_cache $upstream_http_set_cookie;
        fastcgi_cache_valid 200 302 10m;
        fastcgi_cache_valid 301 24h;
        fastcgi_cache_use_stale error timeout invalid_header http_500 http_503 updating;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock on;
        fastcgi_cache_lock_timeout 2s;
        fastcgi_cache_revalidate on;
        fastcgi_cache_min_uses 2;

        fastcgi_cache_key "$scheme$request_method$host$request_uri";
    }

    # -------------------------------------------------------------------
    # Default: dynamic pages (NO FastCGI cache here)
    # -------------------------------------------------------------------
    location / {
        include /etc/nginx/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm_backend;
        fastcgi_keep_conn on;
    }

    error_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.error.log;
    access_log /var/www/labus_pro_usr/data/logs/menu.labus.pro-frontend.access.log;
}

server {
    listen 62.217.178.117:80;
    server_name menu.labus.pro;
    return 301 https://$host$request_uri;
}

server {
    listen 62.217.178.117:80;
    listen 62.217.178.117:443 ssl http2;
    server_name www.menu.labus.pro;
    ssl_certificate "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.crt";
    ssl_certificate_key "/var/www/httpd-cert/menu.labus.pro_2026-02-05-23-49_30.key";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    return 301 $scheme://menu.labus.pro$request_uri;
}
