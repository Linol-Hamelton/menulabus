# üöÄ menu.labus.pro ‚Äî Deep Performance Roadmap (Beget + FastPanel + Nginx+Apache)

**–í–µ—Ä—Å–∏—è:** 1.1 (–ø–æ–ª–Ω–∞—è, –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)  
**–î–∞—Ç–∞:** 2026‚Äë02‚Äë08  
**–¶–µ–ª—å:** –≤—ã–∂–∞—Ç—å –º–∞–∫—Å–∏–º—É–º –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–µ–∫–∞ (**Nginx + Apache (FastPanel) + PHP‚ÄëFPM + MySQL + Redis**) ‚Äî –±—ã—Å—Ç—Ä–µ–µ UI, –±–æ–ª—å—à–µ RPS –∫ –ë–î, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –ø–∏–∫–æ–≤—ã–º–∏ –≤—Å–ø–ª–µ—Å–∫–∞–º–∏.

> –í–∞–∂–Ω–æ –ø—Ä–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ –æ—Ç—á—ë—Ç–∞
> - –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ SSH‚Äë–¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É –∏ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≥–Ω–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã ¬´–∏–∑–Ω—É—Ç—Ä–∏¬ª –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ —á–∞—Ç–∞.
> - –ü–æ—ç—Ç–æ–º—É –Ω–∏–∂–µ: **(–∞)** –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä –∫–æ–¥–∞/–∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, **(–±)** –ø–ª–∞–Ω –∏–∑–º–µ—Ä–µ–Ω–∏–π –∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ¬´–±–µ–∑ –ø–∞–¥–µ–Ω–∏—è¬ª, **(–≤)** –≥–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏/—Å–∫—Ä–∏–ø—Ç—ã/–º–∏–≥—Ä–∞—Ü–∏–∏ –∏ **–ø–æ—ç—Ç–∞–ø–Ω—ã–π rollout**.

---

## 0) –ß—Ç–æ —Å—á–∏—Ç–∞—Ç—å ¬´—É—Å–ø–µ—Ö–æ–º¬ª (SLO/–º–µ—Ç—Ä–∏–∫–∏)

–ü–µ—Ä–µ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –Ω—É–∂–Ω–∞ –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ü–µ–ª–µ–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (—Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è ¬´–¥–æ¬ª –∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ö–∞–∫ –º–µ—Ä–∏—Ç—å | –¶–µ–ª—å |
|---|---|---|
| **TTFB cached** | `curl -w` + `X-Cache-Status` | 10‚Äì20 ms |
| **TTFB uncached** | `curl` —Å bypass –∫—ç—à–∞ | 30‚Äì80 ms |
| **p95 latency** | k6 `http_req_duration p(95)` | < 100 ms |
| **–û—à–∏–±–∫–∏** | k6 `http_req_failed` | < 0.5% |
| **DB query time** | slow log + `pt-query-digest` | –≤ 3‚Äì10√ó –Ω–∏–∂–µ |
| **QPS/RPS** | MySQL status + –Ω–∞–≥—Ä—É–∑–∫–∞ k6 | —Ä–æ—Å—Ç –≤ 3‚Äì10√ó |
| **Cache hit rate** | Redis INFO stats | 95‚Äì98% |
| **PHP‚ÄëFPM saturation** | `/fpm-status?full` | –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π |

### –¢—Ä–∏ ¬´—Ä–µ–∂–∏–º–∞¬ª –Ω–∞–≥—Ä—É–∑–∫–∏
1) **Normal**: –æ–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
2) **Peak**: –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤—Å–ø–ª–µ—Å–∫ (–æ–±–µ–¥–µ–Ω–Ω—ã–π –ø–∏–∫)
3) **Attack‚Äëlike**: –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã (–±–æ—Ç—ã/—Å–∫–∞–Ω–µ—Ä—ã/–ø–ª–æ—Ö–æ–π –∫–ª–∏–µ–Ω—Ç) ‚Äî –¥–æ–ª–∂–Ω—ã –æ—Ç—Å–µ–∏–≤–∞—Ç—å—Å—è rate limit‚Äô–æ–º –∏ –∫—ç—à–µ–º

---

## 1) –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ø–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é) –∏ –∫–ª—é—á–µ–≤—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

### 1.1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ (db.php)

–§–∞–π–ª `db.php` ‚Äî –±–æ–ª—å—à–æ–π –µ–¥–∏–Ω—ã–π Data‚ÄëAccess —Å–ª–æ–π:
- PDO —Å prepared‚Äëstatement –∫—ç—à–µ–º (`prepareCached()`)
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`PDO::ATTR_PERSISTENT => true`)
- –î–≤–∞ –∫—ç—à–∞: **RedisCache** –∏ **QueryCache (APCu/—Ñ–∞–π–ª–æ–≤—ã–π?)**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ —Ç—è–∂—ë–ª—ã–µ –æ—Ç—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `JSON_TABLE()` –ø–æ –∫–æ–ª–æ–Ω–∫–µ `orders.items`.

**–ì–ª–∞–≤–Ω—ã–π bottleneck ‚Ññ1:** JSON‚Äë–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ MySQL.
- –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å —Å `JSON_TABLE()` –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–ª–æ—Ö–æ.
- –ß–µ–º –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–æ–≤, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ ¬´–ø–ª—ã–≤—É—Ç¬ª –æ—Ç—á—ë—Ç—ã –∏ –∞–¥–º–∏–Ω–∫–∞.

**–ì–ª–∞–≤–Ω—ã–π bottleneck ‚Ññ2:** –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ¬´–∏–¥–µ–∞–ª—å–Ω—ã—Ö¬ª —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–¥ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

**–ì–ª–∞–≤–Ω—ã–π bottleneck ‚Ññ3:** —Ä–æ—Å—Ç —Ç–∞–±–ª–∏—Ü –±–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–µ–∑ –ø–æ–ª–∏—Ç–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.

### 1.2. RedisCache

Redis —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –æ–±—ã—á–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–∞—ë—Ç:
- batch (`MGET`/`pipeline`) –≤–º–µ—Å—Ç–æ —Å–æ—Ç–µ–Ω –æ–¥–∏–Ω–æ—á–Ω—ã—Ö `GET`
- –ø—Ä–æ–≥—Ä–µ–≤ (warming) –∏ –∞–Ω—Ç–∏‚Äëstampede (–ª–æ–∫–∏/–¥–∂–∏—Ç—Ç–µ—Ä TTL)
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è ¬´–ø–æ —Ç–µ–≥–∞–º¬ª (–≤–∞—à –∫–æ–¥ —É–∂–µ –∏–º–µ–µ—Ç invalidate –ø–æ –º–∞—Å–∫–µ)

### 1.3. PHP‚ÄëFPM (php-fpm-optimization.conf)

–¢–µ–∫—É—â–∏–π –ø—É–ª:
- `pm = dynamic`, `pm.max_children = 50`
- OPcache –≤–∫–ª—é—á—ë–Ω, JIT –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- –°–µ—Å—Å–∏–∏ –Ω–∞ Redis (—ç—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏)

**–ì–ª–∞–≤–Ω—ã–π bottleneck:** –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ–¥ –ø–∏–∫–∞–º–∏ —Å–æ–∑–¥–∞—ë—Ç:
- –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ —Ñ–æ—Ä–∫ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å CPU/RAM

### 1.4. Nginx (nginx-optimized.conf)

–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å FastCGI cache, skip‚Äë–ª–æ–≥–∏–∫–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Cache-Status`.

**–ì–ª–∞–≤–Ω—ã–π bottleneck:** –Ω–µ –≤–∫–ª—é—á—ë–Ω keepalive –∫ upstream –∏ `fastcgi_keep_conn on;`, –∏ –∫—ç—à/skip‚Äë–ø—Ä–∞–≤–∏–ª–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –µ—â—ë —Ç–æ—á–Ω–µ–µ (—á—Ç–æ–±—ã –º–∞–∫—Å–∏–º—É–º –ø—É–±–ª–∏—á–Ω–æ–≥–æ –±—ã–ª–æ HIT).

### 1.5. Nginx+Apache –≤ FastPanel: –≤–∞–∂–Ω–∞—è —Ä–∞–∑–≤–∏–ª–∫–∞

–í FastPanel –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–≤–∞ —Ä–µ–∂–∏–º–∞:
1) **Nginx ‚Üí PHP‚ÄëFPM –Ω–∞–ø—Ä—è–º—É—é** (–ª—É—á—à–µ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
2) **Nginx ‚Üí Apache ‚Üí PHP** (—Ö—É–∂–µ –ø–æ –Ω–∞–∫–ª–∞–¥–Ω—ã–º —Ä–∞—Å—Ö–æ–¥–∞–º, –Ω–æ –∏–Ω–æ–≥–¥–∞ —Ç–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–¢–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–º nginx‚Äë–∫–æ–Ω—Ñ–∏–≥–µ –µ—Å—Ç—å `fastcgi_pass` –Ω–∞ php‚Äëfpm —Å–æ–∫–µ—Ç, —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç (1). –ù–æ –≤—ã —è–≤–Ω–æ —É–ø–æ–º—è–Ω—É–ª–∏ Nginx+Apache, –∑–Ω–∞—á–∏—Ç:
- –ª–∏–±–æ —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—Å—ë –µ—â—ë –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Apache,
- –ª–∏–±–æ Apache –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ vhost/—Ä—É—Ç—ã,
- –ª–∏–±–æ —É –≤–∞—Å mixed‚Äë—Ä–µ–∂–∏–º.

**–í roadmap –Ω–∏–∂–µ –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**.

---

## 2) ¬´–ù–µ —É—Ä–æ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç¬ª: –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–µ—Ç–æ–¥–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏ rollout

### 2.1. –ü–æ–ª–∏—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ)

**–ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:**
- –ù–∏–∫–∞–∫–∏—Ö ¬´–Ω–∞ –≥–ª–∞–∑¬ª 500 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ä–∞–∑—É.
- –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å k6 –ø–æ —Å—Ç—É–ø–µ–Ω—è–º —Å stop‚Äë—É—Å–ª–æ–≤–∏—è–º–∏.
- –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ **staging‚Äë–∫–æ–ø–∏–∏** (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ), –∑–∞—Ç–µ–º ‚Äî –Ω–æ—á—å—é/–≤ –Ω–µ–ø–∏–∫ –Ω–∞ production.

### 2.2. –°—Ç–æ–ø‚Äë—É—Å–ª–æ–≤–∏—è (circuit breaker)
–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ç–µ—Å—Ç, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ö–æ—Ç—å –æ–¥–Ω–æ:
- `http_req_failed > 0.5%`
- p95 > 250 ms (–≤ —Ç–µ—á–µ–Ω–∏–µ 1 –º–∏–Ω—É—Ç—ã)
- CPU > 90% sustained 2‚Äì3 –º–∏–Ω
- RAM > 90%
- —Ä–æ—Å—Ç 5xx –∏–ª–∏ 502/504

### 2.3. –ú–∏–Ω–∏‚Äë—Ç–µ—Å—Ç ¬´–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è¬ª

```bash
curl -I https://menu.labus.pro/menu.php | egrep -i 'x-cache-status|server|cache-control'

# 20 –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
for i in {1..20}; do curl -s -o /dev/null -w '%{time_total}\n' https://menu.labus.pro/menu.php; done | sort -n | tail
```

---

## 3) Roadmap –ø–æ —Ñ–∞–∑–∞–º (6 –Ω–µ–¥–µ–ª—å) ‚Äî –º–∞–∫—Å–∏–º—É–º —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ä–∏—Å–∫–æ–º

### –ù–µ–¥–µ–ª—è 0 (–¥–µ–Ω—å 0): baseline + –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤ Beget

1) –£—Ç–æ—á–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã:
- RAM/CPU (—Ç–∞—Ä–∏—Ñ)
- MySQL –ª–∏–º–∏—Ç—ã, –¥–æ—Å—Ç—É–ø –∫ `my.cnf`, allowed GLOBAL changes
- –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞–≤–∏—Ç—å Redis/Percona tools

2) –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å baseline:
- `TTFB cached/uncached`
- k6 p95/p99
- —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∫–ª—é—á–µ–≤—ã—Ö SQL (`EXPLAIN ANALYZE` –µ—Å–ª–∏ MySQL 8)
- Redis hit rate
- PHP‚ÄëFPM status (`/fpm-status?full`)

3) –ë—ç–∫–∞–ø—ã:
- `mysqldump`
- —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ nginx/apache/php-fpm/mysql/redis

---

## –ù–µ–¥–µ–ª—è 1: MySQL ‚Äî –∏–Ω–¥–µ–∫—Å—ã ¬´–ø–æ–¥ –∑–∞–ø—Ä–æ—Å—ã¬ª (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –ø—Ä–∏—Ä–æ—Å—Ç)

### 3.1. –í–∫–ª—é—á–∏—Ç—å slow query log –∏ —Å–æ–±—Ä–∞—Ç—å —Ñ–∞–∫—Ç—ã

–ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø:
- –≤–∫–ª—é—á–∏—Ç—å slow log
- –ø–æ—Å—Ç–∞–≤–∏—Ç—å `pt-query-digest` (Percona Toolkit)

–¶–µ–ª—å: –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ø‚Äë20 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ total time.

### 3.2. –ò–Ω–¥–µ–∫—Å—ã (–º–∏–≥—Ä–∞—Ü–∏—è v1)

> –ù–∏–∂–µ ‚Äî ¬´—Ä–∞–∑—É–º–Ω—ã–π –º–∏–Ω–∏–º—É–º¬ª. –¢–æ—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω–æ —Å–≤–µ—Ä–∏—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ EXPLAIN –≤–∞—à–∏—Ö —Ç–æ–ø‚Äë–∑–∞–ø—Ä–æ—Å–æ–≤.

```sql
-- menu_items: —Ñ–∏–ª—å—Ç—Ä available + category + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
ALTER TABLE menu_items
  ADD INDEX idx_menu_available_category_name (available, category, name);

-- orders: –æ—Ç—á—ë—Ç—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –≤—Ä–µ–º–µ–Ω–∏
ALTER TABLE orders
  ADD INDEX idx_orders_status_created (status, created_at);

-- orders: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "–º–æ–∏ –∑–∞–∫–∞–∑—ã"
ALTER TABLE orders
  ADD INDEX idx_orders_user_created (user_id, created_at);

-- order_status_history: –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
ALTER TABLE order_status_history
  ADD INDEX idx_history_order_changed (order_id, changed_at);

-- users: —á–∞—Å—Ç—ã–µ –≤—ã–±–æ—Ä–∫–∏ –ø–æ email
ALTER TABLE users
  ADD INDEX idx_users_email (email);
```

### 3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ EXPLAIN ¬´–¥–æ/–ø–æ—Å–ª–µ¬ª

```sql
EXPLAIN SELECT id,name,price FROM menu_items
WHERE available=1 AND category='...' ORDER BY name;
```

–¶–µ–ª—å: —É–π—Ç–∏ –æ—Ç `Using filesort` –∏ full scan.

---

## –ù–µ–¥–µ–ª—è 2: MySQL ‚Äî –±–æ—Ä—å–±–∞ —Å JSON_TABLE –∏ —Ä–æ—Å—Ç–æ–º —Ç–∞–±–ª–∏—Ü

### 3.4. –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ä—ã–≤: ¬´—Ä–∞–∑—É–ø–ª–æ—Ç–Ω–∏—Ç—å¬ª orders.items

–°–µ–π—á–∞—Å `orders.items` ‚Äî JSON, –∞ –æ—Ç—á—ë—Ç—ã –¥–µ–ª–∞—é—Ç `JSON_TABLE()`.

**–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Ññ1 (–ª—É—á—à–∏–π): –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**
- –∑–∞–≤–µ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—É `order_items(order_id, item_id, qty, price, cost_snapshot, created_at)`
- –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –ø–∏—Å–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ order_items
- –æ—Ç—á—ë—Ç—ã —Å—Ç—Ä–æ–∏—Ç—å –ø–æ –æ–±—ã—á–Ω—ã–º JOIN+GROUP BY (–±—ã—Å—Ç—Ä–æ –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)

**–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Ññ2 (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö): generated columns + –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã**
- –¥–æ–±–∞–≤–∏—Ç—å generated/–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è: item_count, first_item_id, (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) cost_sum, profit_sum
- —Ç—è–∂—ë–ª—ã–µ –æ—Ç—á—ë—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ —ç—Ç–∏ –ø–æ–ª—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –Ω–∞—á–∞—Ç—å —Å –ø–æ–¥—Ö–æ–¥–∞ ‚Ññ2 (–±—ã—Å—Ç—Ä–µ–µ –≤–Ω–µ–¥—Ä–∏—Ç—å), –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ ‚Ññ1 –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏.

#### –í–∞—Ä–∏–∞–Ω—Ç A: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è high‚Äëload)

**DDL:**
```sql
CREATE TABLE order_items (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  order_id BIGINT UNSIGNED NOT NULL,
  item_id BIGINT UNSIGNED NOT NULL,
  quantity INT NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  cost_snapshot DECIMAL(10,2) NULL,
  created_at DATETIME NOT NULL,
  PRIMARY KEY (id),
  KEY idx_order_items_order (order_id),
  KEY idx_order_items_item (item_id),
  KEY idx_order_items_created (created_at)
) ENGINE=InnoDB;
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ createOrder/createGuestOrder:**
- –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ orders ‚Äî –≤—Å—Ç–∞–≤–ª—è—Ç—å –±–∞—Ç—á–µ–º `order_items`.

–ü–ª—é—Å—ã:
- –æ—Ç—á—ë—Ç—ã —É—Å–∫–æ—Ä—è—é—Ç—Å—è –Ω–∞ –ø–æ—Ä—è–¥–æ–∫
- –ø—Ä–æ—â–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- –º–µ–Ω—å—à–µ CPU –Ω–∞ JSON

–ú–∏–Ω—É—Å—ã:
- –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

#### –í–∞—Ä–∏–∞–Ω—Ç B: generated columns (–±—ã—Å—Ç—Ä—ã–π win)

```sql
ALTER TABLE orders
  ADD COLUMN total_items INT
    GENERATED ALWAYS AS (JSON_LENGTH(items)) VIRTUAL,
  ADD INDEX idx_orders_total_items (total_items);
```

–≠—Ç–æ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É, –Ω–æ —É–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–±—Ä–∞—Ç—å —á–∞—Å—Ç—å JSON‚Äë–ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤.

### 3.5. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ / –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ

–ï—Å–ª–∏ `orders` —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–æ ‚Äî –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü—É (RANGE) –¥–∞—Å—Ç —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–∫–∞–Ω–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

–í–∞–∂–Ω–æ: –≤ MySQL –µ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ PRIMARY KEY –ø—Ä–∏ partitioning. –î–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –±—ç–∫–∞–ø–∞ –∏ —Ç–µ—Å—Ç–∞ –Ω–∞ –∫–æ–ø–∏–∏.

---

## –ù–µ–¥–µ–ª—è 3: PHP‚ÄëFPM ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è

### 3.6. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `pm = static`

–ü–ª—é—Å: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ¬´—Ñ–æ—Ä–∫‚Äë–ø–∏–ª—ã¬ª.

1) –ó–∞–º–µ—Ä–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–π RSS php‚Äë–ø—Ä–æ—Ü–µ—Å—Å–∞:
```bash
ps -o rss= -C php-fpm8.0 | awk '{sum+=$1; n++} END{print sum/n/1024" MB"}'
```

2) –†–∞—Å—Å—á–∏—Ç–∞—Ç—å max_children:
- –≤–∑—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω—É—é RAM
- –≤—ã—á–µ—Å—Ç—å MySQL+Redis+—Å–∏—Å—Ç–µ–º—É
- —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ —Å—Ä–µ–¥–Ω–∏–π RSS
- –æ—Å—Ç–∞–≤–∏—Ç—å 20‚Äì30% –∑–∞–ø–∞—Å

3) –ü—Ä–∏–º–µ—Ä (–Ω–∞ —Å—Ç–∞—Ä—Ç–µ):
```ini
pm = static
pm.max_children = 30
pm.max_requests = 1000
```

### 3.7. OPcache –∫–∞–∫ production

–î–ª—è production (–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ FPM):
```ini
php_admin_value[opcache.enable]=1
php_admin_value[opcache.memory_consumption]=512
php_admin_value[opcache.max_accelerated_files]=20000
php_admin_value[opcache.validate_timestamps]=0
php_admin_value[opcache.revalidate_freq]=0
```

### 3.8. JIT (–µ—Å–ª–∏ PHP 8+)

```ini
php_admin_value[opcache.jit]=tracing
php_admin_value[opcache.jit_buffer_size]=128M
```

> –í–∞–∂–Ω–æ: JIT ‚Äî –Ω–µ –≤—Å–µ–≥–¥–∞ —É—Å–∫–æ—Ä—è–µ—Ç I/O bound –∫–æ–¥. –ù–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ JSON/—Å—Ç—Ä–æ–∫ –æ–±—ã—á–Ω–æ –¥–∞—ë—Ç –ø–ª—é—Å.

### 3.9. Preload

–°–æ–∑–¥–∞—Ç—å `preload.php` –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ `opcache.preload`.

---

## –ù–µ–¥–µ–ª—è 4: Redis 2.0 ‚Äî –ø—Ä–æ–≥—Ä–µ–≤, batch, –∞–Ω—Ç–∏‚Äëstampede

### 3.10. –î–æ–±–∞–≤–∏—Ç—å batch –æ–ø–µ—Ä–∞—Ü–∏–∏

–í `RedisCache.php` –¥–æ–±–∞–≤–∏—Ç—å:
- `mget()`
- `mset()` —á–µ—Ä–µ–∑ pipeline
- `getOrSet()`

–ö–ª—é—á–µ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç: –ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ–≤–µ/—Ä–µ–Ω–¥–µ—Ä–µ –º–µ–Ω—é —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ round‚Äëtrip –∫ Redis.

### 3.11. –ü—Ä–æ–≥—Ä–µ–≤ (cache‚Äëwarmer)

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≥—Ä–µ–≤–∞:
- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –º–µ–Ω—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- –º–µ–Ω—é –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

Cron –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç (–∏–ª–∏ —á–∞—â–µ –≤ –ø–∏–∫–µ):
```bash
*/15 * * * * /usr/bin/php /var/www/.../scripts/cache-warmer.php >> /var/log/cache-warmer.log 2>&1
```

### 3.12. TTL —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

–ï—Å–ª–∏ –º–µ–Ω—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ ‚Äî TTL –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å:
- menu: 2‚Äì6 —á–∞—Å–æ–≤
- categories: 6‚Äì24 —á–∞—Å–∞
- product: 1‚Äì2 —á–∞—Å–∞

–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å **–ø–æ —Å–æ–±—ã—Ç–∏—é** (update/add menu item), –∞ –Ω–µ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏—é TTL.

---

## –ù–µ–¥–µ–ª—è 5: Nginx ‚Äî keepalive, microcache –∏ ¬´–º–∞–∫—Å–∏–º—É–º HIT¬ª

### 3.13. Keepalive –∫ PHP‚ÄëFPM

```nginx
upstream php_fpm_backend {
  server unix:/var/run/menu.labus.pro.sock;
  keepalive 32;
}

location / {
  fastcgi_pass php_fpm_backend;
  fastcgi_keep_conn on;
}
```

### 3.14. FastCGI cache: —É–≤–µ–ª–∏—á–∏—Ç—å TTL –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

–ï—Å–ª–∏ `/menu.php` –æ—Ç–¥–∞—ë—Ç ¬´–ø—É–±–ª–∏—á–Ω—É—é¬ª –≤–µ—Ä—Å–∏—é –±–µ–∑ —Å–µ—Å—Å–∏–∏ ‚Äî TTL –º–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å –¥–æ 2‚Äì4 —á–∞—Å–æ–≤.

### 3.15. Microcache 1‚Äì5 —Å–µ–∫ –¥–ª—è –≥–æ—Ä—è—á–∏—Ö GET‚Äëendpoint‚Äô–æ–≤

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç ¬´—à–∫–≤–∞–ª–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤¬ª.

---

## –ù–µ–¥–µ–ª—è 6: –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### 3.16. –ê–≤—Ç–æ‚Äë–∞–Ω–∞–ª–∏–∑ slow log
- weekly –æ—Ç—á—ë—Ç `pt-query-digest`
- —Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç—ã 4 –Ω–µ–¥–µ–ª–∏

### 3.17. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ¬´–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º¬ª

–°–¥–µ–ª–∞—Ç—å `monitor/db-monitor.php`:
- Redis hits/misses
- MySQL threads, slow queries
- OPcache status (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

### 3.18. –ë—ç–∫–∞–ø—ã –∏ housekeeping
- –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø –ë–î
- –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–∏—Å–∫–∞
- —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤

---

## 4) –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ (—Ç–æ—á–µ—á–Ω–æ, –Ω–æ —Å –±–æ–ª—å—à–∏–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º)

### 4.1. –°–Ω–∏–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL‚Äë–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω page view

–ü—Ä–∏–Ω—Ü–∏–ø: –æ–¥–∏–Ω UI‚Äë—ç–∫—Ä–∞–Ω = 1‚Äì3 SQL –º–∞–∫—Å–∏–º—É–º (–≤ –∏–¥–µ–∞–ª–µ 0 –ø—Ä–∏ –∫—ç—à–µ).

–ß–µ–∫‚Äë–ª–∏—Å—Ç:
- –∑–∞–ø—Ä–µ—Ç–∏—Ç—å N+1 (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –¥–ª—è –º–µ–Ω—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å (–∏–ª–∏ Redis)
- –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å APCu (L1)

### 4.2. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (L1 APCu, L2 Redis)

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ö–µ–º–∞:
- **APCu**: settings, feature flags, –º–µ–ª–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
- **Redis**: menu, products, –∞–≥—Ä–µ–≥–∞—Ç—ã, –ø—É–±–ª–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

### 4.3. –ê–Ω—Ç–∏‚Äëstampede –¥–ª—è cache miss

–ü–æ–¥—Ö–æ–¥:
- –∫–ª—é—á `lock:menu:category:X` –Ω–∞ 2‚Äì5 —Å–µ–∫
- –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ç—Ä–æ–∏—Ç –∫—ç—à
- –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç/–ø–æ–ª—É—á–∞—é—Ç stale

---

## 5) –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (k6) ¬´–Ω–∞ –º–∞–∫—Å–∏–º—É–º, –Ω–æ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è¬ª

### 5.1. –õ–µ—Å—Ç–Ω–∏—Ü–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

- 1 –º–∏–Ω: 10 VU
- 3 –º–∏–Ω: 30 VU
- 3 –º–∏–Ω: 60 VU
- 2 –º–∏–Ω: 100 VU

–ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ SLO —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å.

### 5.2. k6 —Å–∫—Ä–∏–ø—Ç (—à–∞–±–ª–æ–Ω)

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },
    { duration: '2m', target: 30 },
    { duration: '3m', target: 60 },
    { duration: '2m', target: 100 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_failed: ['rate<0.005'],
    http_req_duration: ['p(95)<100', 'p(99)<200'],
  },
};

const BASE = 'https://menu.labus.pro';

export default function () {
  const r1 = http.get(`${BASE}/menu.php`);
  check(r1, { 'menu 200': (r) => r.status === 200 });
  sleep(0.5);

  const r2 = http.get(`${BASE}/menu.php?category=${encodeURIComponent('–°–∞–ª–∞—Ç—ã')}`);
  check(r2, { 'cat 200': (r) => r.status === 200 });
  sleep(0.8);
}
```

### 5.3. –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å ¬´–∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞¬ª

–ù—É–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å **–º–∞—Ç—Ä–∏—Ü—É —ç–∫—Ä–∞–Ω–æ–≤** –∏ —Ç–∏–ø–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:
- –ø—É–±–ª–∏—á–Ω–æ–µ –º–µ–Ω—é
- –ø–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä
- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –∫–æ—Ä–∑–∏–Ω–∞
- —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- –∫–∞–±–∏–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞/–≤–ª–∞–¥–µ–ª—å—Ü–∞
- —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
- –æ—Ç—á—ë—Ç—ã

–î–ª—è –∫–∞–∂–¥–æ–≥–æ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π k6 (–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ thresholds).

---

## 6) –ì–æ—Ç–æ–≤—ã–µ ¬´–±–æ–µ–≤—ã–µ¬ª –∫–æ–Ω—Ñ–∏–≥–∏ (—ç—Ç–∞–ª–æ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã)

### 6.1. PHP‚ÄëFPM (—à–∞–±–ª–æ–Ω, –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ max_children)

```ini
[menu.labus.pro]
user = labus_pro_usr
group = labus_pro_usr
listen = /var/run/menu.labus.pro.sock
listen.owner = labus_pro_usr
listen.group = www-data
listen.mode = 0660

pm = static
pm.max_children = 30
pm.max_requests = 1000

pm.status_path = /fpm-status
request_slowlog_timeout = 10s
slowlog = /var/www/labus_pro_usr/data/logs/menu.labus.pro-slow.log

php_admin_value[opcache.enable]=1
php_admin_value[opcache.memory_consumption]=512
php_admin_value[opcache.max_accelerated_files]=20000
php_admin_value[opcache.validate_timestamps]=0
php_admin_value[opcache.revalidate_freq]=0

; JIT (–µ—Å–ª–∏ PHP 8+)
php_admin_value[opcache.jit]=tracing
php_admin_value[opcache.jit_buffer_size]=128M

; sessions -> redis
php_admin_value[session.save_handler]=redis
php_admin_value[session.save_path]="tcp://127.0.0.1:6379?database=0"
```

### 6.2. Nginx (–∫–ª—é—á–µ–≤—ã–µ –≤—Å—Ç–∞–≤–∫–∏)

```nginx
fastcgi_cache_path /var/cache/nginx/fastcgi_menu levels=1:2
  keys_zone=MENUCACHE:100m inactive=2h max_size=2g;

upstream php_fpm_backend {
  server unix:/var/run/menu.labus.pro.sock;
  keepalive 32;
}

map $http_cookie $has_session {
  default 0;
  ~*PHPSESSID 1;
}

server {
  # ... ssl, root ...

  set $skip_cache 0;
  if ($request_method = POST) { set $skip_cache 1; }
  if ($has_session = 1) { set $skip_cache 1; }
  if ($request_uri ~* "/admin|/owner|/employee|/account|/api") { set $skip_cache 1; }
  if ($args) { set $skip_cache 1; }

  location = /menu.php {
    fastcgi_pass php_fpm_backend;
    fastcgi_keep_conn on;
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    fastcgi_cache MENUCACHE;
    fastcgi_cache_bypass $skip_cache;
    fastcgi_no_cache $skip_cache;
    fastcgi_cache_valid 200 2h;
    fastcgi_cache_use_stale updating error timeout http_500 http_503;
    fastcgi_cache_lock on;

    add_header X-Cache-Status $upstream_cache_status;
  }
}
```

### 6.3. Apache (–µ—Å–ª–∏ –≤—Å—ë –∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ü–µ–ø–æ—á–∫–µ)

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç Nginx ‚Üí Apache:
- –≤–∫–ª—é—á–∏—Ç—å `mpm_event`
- —É–º–µ–Ω—å—à–∏—Ç—å KeepAliveTimeout (–Ω–∞–ø—Ä–∏–º–µ—Ä 2‚Äì5 —Å–µ–∫)
- –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `MaxRequestWorkers` –ø–æ RAM
- —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ PHP –∏–¥—ë—Ç —á–µ—Ä–µ–∑ php‚Äëfpm (proxy_fcgi), –∞ –Ω–µ mod_php

> –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ Apache –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ FastPanel.

---

## 7) –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞

1) –û—Ç–∫–∞—Ç nginx –∫–æ–Ω—Ñ–∏–≥–æ–≤ + `nginx -t && systemctl reload nginx`
2) –û—Ç–∫–∞—Ç php-fpm –ø—É–ª–∞ + restart FPM
3) –û—Ç–∫–∞—Ç SQL –º–∏–≥—Ä–∞—Ü–∏–π (drop indexes / revert columns)
4) –û—á–∏—Å—Ç–∫–∞ Redis (–ø—Ä–∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∫–ª—é—á–∞—Ö)

---

## 8) –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∑–∞ 1 –¥–µ–Ω—å)

1) **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è menu_items –∏ orders** (1‚Äì2 —á–∞—Å–∞)
2) **pm=static (–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π) + production OPcache** (1 —á–∞—Å)
3) **Nginx keepalive + fastcgi_keep_conn** (30 –º–∏–Ω—É—Ç)
4) **Redis warming cron** (1 —á–∞—Å)

–≠—Ç–æ –æ–±—ã—á–Ω–æ –¥–∞—ë—Ç —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å–∫–∞—á–æ–∫ –±–µ–∑ —Ä–∏—Å–∫–∞.

---

## 9) –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (—á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å roadmap ¬´–∏–¥–µ–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º¬ª)

–ß—Ç–æ–±—ã –¥–æ–≤–µ—Å—Ç–∏ –ø–ª–∞–Ω –¥–æ —É—Ä–æ–≤–Ω—è ¬´–ø–æ–¥ –≤–∞—à—É —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É¬ª –Ω—É–∂–Ω—ã 3 —Ñ–∞–∫—Ç–∞:
1) —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (RAM/CPU)
2) slow query top‚Äë20 –∏–∑ pt‚Äëquery‚Äëdigest
3) —Ä–µ–∑—É–ª—å—Ç–∞—Ç k6 baseline (p95/p99, RPS, –æ—à–∏–±–∫–∏)

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ:
- —Ç–æ—á–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å max_children
- –≤—ã–±—Ä–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–±–µ–∑ –ª–∏—à–Ω–∏—Ö)
- –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≥–¥–µ –∫—ç—à –≤—ã–≥–æ–¥–Ω–µ–µ: Redis vs FastCGI

